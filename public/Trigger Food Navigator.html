<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trigger Food Navigator</title>
  <!-- Replace local fonts with Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Remove local font imports */
    /* Base styles and CSS variables */
    :root {
      /* Light Theme (Default) */
      --primary: #4489c9;
      --secondary: #062a39;
      --accent: #51baad;
      --highlight: #a3c962;
      --background: #ffffff;
      --text: #062a39;
      --card-bg: #ffffff;
      --border-color: #4489c9;
    }
    
    /* Dark Theme */
    [data-theme="dark"] {
      --primary: #51baad;
      --secondary: #ffffff;
      --accent: #4489c9;
      --highlight: #062a39;
      --background: #062a39;
      --text: #ffffff;
      --card-bg: #051f2a;
      --border-color: #51baad;
    }
    
    /* Theme Switcher */
    .theme-switch {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--background);
      cursor: pointer;
    }
    
    .theme-switch-icon {
      width: 24px;
      height: 24px;
      fill: var(--background);
    }
    
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--background);
      color: var(--text);
      font-size: var(--base-font);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    /* Header */
    header {
      height: 60px;
      background: var(--primary);
      color: var(--background);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      margin-bottom: 20px;
      padding: 0 20px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      height: 100%;
      position: relative;
    }

    .logo {
      height: 45px;
      width: auto;
      object-fit: contain;
      display: block;
    }

    header h1 {
      font-size: 1.8em;
      text-align: center;
      margin: 0 auto;
      flex: 1;
    }

    @media (max-width: 768px) {
      .header-content {
        gap: 10px;
      }

      .logo {
        height: 35px;
      }

      header h1 {
        font-size: 1.4em;
      }
    }
    
    /* Verification Overlay */
    .verification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #4489c9;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.8s ease-in-out;
    }
    
    .fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .main-content-hidden {
      display: none !important;
    }

    /* Verification Form */
    .form {
      --glow-color: var(--primary);
      --glow-spread-color: var(--secondary);
      --enhanced-glow-color: var(--accent);
      --btn-color: rgba(6, 42, 57, 0.8);
      border: 2px solid var(--glow-color);
      padding: 25px;
      display: flex;
      max-width: 900px;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      color: var(--glow-color);
      background-color: var(--btn-color);
      border-radius: 30px;
      position: relative;
    }

    .form .info {
      text-align: center;
      margin-bottom: 20px;
    }

    .form .title {
      font-size: 1.5em;
      font-weight: bold;
      color: white;
      margin-bottom: 10px;
      display: block;
    }

    .form .description {
      color: #E8F4FC;
      margin-bottom: 20px;
    }

    /* Input Fields */
    .form .input-fields {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 15px 0;
    }

    .form .input-fields input {
      height: 2.5em;
      width: 2.5em;
      outline: none;
      text-align: center;
      font-size: 1.5rem;
      color: #fff;
      border-radius: 12px;
      border: 2.5px solid rgba(253, 253, 253, 0.363);
      background-color: rgb(255 255 255 / 0.05);
      text-transform: uppercase;
    }

    .form .input-fields input:focus {
      border: 1px solid var(--primary);
      box-shadow: inset -1px -1px 5px rgba(255, 255, 255, .6),
            inset 10px 10px 10px rgba(0, 0, 0, .25);
      transform: scale(1.05);
      transition: 0.5s;
    }

    /* Verification Message */
    .verification-message {
      display: none;
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
      font-size: 1.1em;
      font-weight: bold;
      text-align: center;
    }

    .verification-error {
      background-color: rgba(255, 0, 0, 0.2);
      color: #ff3333;
      border: 1px solid #ff3333;
    }

    .verification-success {
      background-color: rgba(163, 201, 98, 0.2);
      color: #51baad;
      border: 1px solid #51baad;
      text-shadow: 0 0 10px rgba(81, 186, 173, 0.5);
    }

    /* Verify Button */
    .verify {
      padding: 12px 35px;
      text-transform: uppercase;
      text-decoration: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--background);
      text-shadow: none;
      background: var(--primary);
      box-shadow: transparent;
      border: 1px solid var(--primary);
      transition: 0.5s ease;
      user-select: none;
      cursor: pointer;
    }

    .verify:hover {
      color: #ffffff;
      background: var(--accent);
      border: 1px solid var(--accent);
      text-shadow: 0 0 5px #ffffff,
                  0 0 10px #ffffff,
                  0 0 20px #ffffff;
      box-shadow: 0 0 5px var(--accent),
                  0 0 20px var(--accent),
                  0 0 50px var(--accent),
                  0 0 100px var(--accent);
    }

    /* Main Layout */
    .main-wrapper {
      display: flex;
      height: calc(100vh - 100px);
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    /* Left Sidebar */
    #savedMealsPanel {
      width: 350px;
      background: var(--background);
      color: var(--secondary);
      padding: 15px;
      border-right: 2px solid var(--accent);
      overflow-y: auto;
    }

    /* Center Content */
    #mainContentInner {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      background: var(--background);
    }

    /* Right Panel */
    #rightToolsPanel {
      width: 350px;
      background: var(--background);
      color: var(--secondary);
      padding: 15px;
      border-left: 2px solid var(--accent);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #rightToolsPanel h2 {
      color: var(--secondary);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
      font-size: 1.1em;
    }

    #rightToolsPanel h3 {
      color: var(--text);
      margin-bottom: 10px;
      font-size: 1em;
    }

    /* Food Selection */
    .food-selection {
      display: grid !important;
      grid-template-columns: repeat(9, 1fr) !important;
      gap: 10px;
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100px;
      background: var(--background);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      visibility: visible !important;
      opacity: 1 !important;
    }

    .food-item {
      display: flex !important;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--card-bg);
      position: relative;
      min-height: 100px;
      margin: 2px;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .food-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .food-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      margin-bottom: 5px;
      border-radius: 4px;
      background: #f5f5f5;
    }

    .food-toggle-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 0.85em;
      cursor: pointer;
      padding: 4px 8px;
      text-align: center;
      width: 100%;
      font-weight: 500;
      border-radius: 4px;
      transition: all 0.2s ease;
      margin-top: auto;
    }

    .food-toggle-btn:hover {
      background-color: rgba(81, 186, 173, 0.1);
    }

    .food-item.selected {
      background: var(--highlight);
      border-color: var(--accent);
      transform: scale(1.05);
    }

    .food-item.selected .food-toggle-btn {
      color: var(--accent);
      font-weight: 600;
    }

    /* Dietary Preferences */
    .preference-selection {
      display: flex;
      gap: 15px;
      padding: 15px;
      justify-content: center;
    }

    .preference-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .preference-option:hover {
      background: var(--accent);
    }

    .preference-option input[type="radio"] {
      display: none;
    }

    .preference-option label {
      cursor: pointer;
      color: white;
    }

    .preference-option.selected {
      background: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Meal Type Filter */
    .meal-type-filter {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 5px;
    }

    .meal-type-filter label {
      color: var(--text);
      font-weight: 500;
    }

    .meal-type-filter select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--background);
      color: var(--text);
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .meal-type-filter select:hover {
      border-color: var(--accent);
    }

    .meal-type-filter select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(81, 186, 173, 0.2);
    }

    /* Button Group */
    .button-group {
      display: flex;
      gap: 15px;
      padding: 15px;
      justify-content: center;
    }

    .button-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-group button:hover {
      background: var(--accent);
    }

    .fetch-recipes-btn {
      background: var(--accent) !important;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .fetch-recipes-btn:hover {
      background: var(--primary) !important;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Replacement Display */
    #replacementDisplay {
      display: flex;
      gap: 20px;
      padding: 15px;
      width: 100%;
      overflow-x: auto;
      margin: 0 auto;
    }

    .replacement-card {
      flex: 1 1 0;
      min-width: 250px;
      max-width: calc((100% - 40px) / 3); /* For 3 cards with 20px gap */
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      opacity: 0;
      transform: translateX(-50px);
      transition: all 0.5s ease;
    }

    .replacement-card.show {
      opacity: 1;
      transform: translateX(0);
    }

    /* Adjust card sizes based on number of cards */
    #replacementDisplay:has(.replacement-card:only-child) .replacement-card {
      max-width: 100%;
    }

    #replacementDisplay:has(.replacement-card:nth-child(2)) .replacement-card {
      max-width: calc((100% - 20px) / 2);
    }

    /* Add responsive adjustments */
    @media (max-width: 768px) {
      .replacement-card {
        min-width: 200px;
        max-width: 100%;
      }
    }

    /* Meal Cards Container */
    #replacementMeal {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      width: 100%;
      overflow-x: auto;
      margin: 0 auto;
      flex-wrap: wrap;
    }

    /* Ensure 3 cards fit in available space */
    @media (min-width: 1200px) {
      .meal-card {
        min-width: 480px;
        max-width: 520px;
      }
    }

    @media (max-width: 1199px) {
      .meal-card {
        min-width: 420px;
        max-width: 480px;
      }
    }

    @media (max-width: 900px) {
      #replacementMeal {
        flex-direction: column;
        align-items: center;
      }
      
      .meal-card {
        min-width: 380px;
        max-width: 500px;
        margin: 10px 0;
      }
    }

    /* Meal Cards */
    .meal-card {
      flex: 0 0 auto;
      min-width: 450px;
      max-width: 500px;
      height: 600px;
      padding: 18px;
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: var(--background);
      position: relative;
      opacity: 0;
      transform: translateX(-50px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      display: flex;
      flex-direction: column;
      margin: 8px;
      overflow: hidden;
    }

    .meal-card.show {
      opacity: 1;
      transform: translateX(0);
    }

    .meal-card.expanded {
      height: auto;
    }

    .meal-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .meal-card h3 {
      margin: 0 0 10px 0;
      color: var(--text);
      font-size: 1.15em;
      line-height: 1.3;
    }

    .meal-card .calories-macros {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
      width: 100%;
    }

    .meal-card .calories {
      font-weight: bold;
      color: var(--accent);
      flex: 0 0 auto;
    }

    .meal-card .macros {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }

    .meal-card .macro-item {
      text-align: center;
      flex: 0 0 auto;
      min-width: 50px;
      padding: 4px;
      background: var(--card-bg);
      border-radius: 4px;
    }

    .meal-card .macro-value {
      font-weight: bold;
      color: var(--accent);
      font-size: 0.8em;
    }

    .meal-card .macro-label {
      font-size: 0.7em;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .meal-card .ingredients {
      margin-bottom: 12px;
      overflow: hidden;
      max-height: 100px;
    }

    .meal-card .recipe {
      margin-top: 12px;
      overflow: hidden;
      max-height: 100px;
    }

    .meal-card .cooks-notes {
      margin-top: 12px;
      padding: 12px;
      background: rgba(81, 186, 173, 0.1);
      border-left: 4px solid var(--accent);
      border-radius: 4px;
      overflow: hidden;
      max-height: 80px;
    }

    .meal-card .cooks-notes h4 {
      margin: 0 0 8px 0;
      color: var(--accent);
      font-size: 0.9em;
      font-weight: bold;
    }

    .meal-card .cooks-notes ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .meal-card .cooks-notes li {
      padding: 4px 0;
      font-size: 0.85em;
      color: var(--text);
      line-height: 1.4;
      position: relative;
      padding-left: 15px;
    }

    .meal-card .cooks-notes li::before {
      content: "💡";
      position: absolute;
      left: 0;
      top: 4px;
      font-size: 0.8em;
    }

    .meal-card .read-more {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      background: linear-gradient(to top, var(--background) 50%, transparent);
      text-align: center;
      cursor: pointer;
      color: var(--accent);
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .meal-card .read-more:hover {
      color: var(--primary);
    }

    .meal-card.expanded .read-more {
      display: none;
    }

    .meal-card.expanded .ingredients,
    .meal-card.expanded .recipe,
    .meal-card.expanded .cooks-notes {
      max-height: none;
    }

    .meal-card .add-to-saved {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .meal-card .add-to-saved:hover {
      background: var(--primary);
      transform: scale(1.1);
    }

    /* Add smooth scrolling for the containers */
    #replacementDisplay, #replacementMeal {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
      padding-bottom: 10px; /* Add padding for scrollbar */
    }

    /* Style the scrollbars */
    #replacementDisplay::-webkit-scrollbar,
    #replacementMeal::-webkit-scrollbar {
      height: 8px;
    }

    #replacementDisplay::-webkit-scrollbar-track,
    #replacementMeal::-webkit-scrollbar-track {
      background: transparent;
    }

    #replacementDisplay::-webkit-scrollbar-thumb,
    #replacementMeal::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      #replacementDisplay, #replacementMeal {
        padding: 10px;
        justify-content: flex-start;
      }
      
      .replacement-card, .meal-card {
        min-width: 300px;
        max-width: 400px;
      }
    }

    .replacement-card h3 {
      color: var(--text);
      margin-bottom: 15px;
      font-size: 1.2em;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 5px;
    }

    .replacement-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 150px;
      overflow: hidden;
    }

    .replacement-card li {
      padding: 12px 0;
      color: var(--text);
      border-bottom: 1px solid rgba(81, 186, 173, 0.1);
    }

    .replacement-card .view-details-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 10px;
      width: 100%;
    }

    .replacement-card .view-details-btn:hover {
      background: var(--accent);
    }

    /* Replacement Modal Styles */
    .replacement-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .replacement-modal-content {
      background: var(--card-bg);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      border-radius: 8px;
      padding: 20px;
      position: relative;
      overflow-y: auto;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .replacement-modal-content.show {
      opacity: 1;
      transform: translateY(0);
    }

    .replacement-modal h2 {
      color: var(--text);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
    }

    .replacement-modal ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .replacement-modal li {
      padding: 12px 0;
      color: var(--text);
      border-bottom: 1px solid rgba(81, 186, 173, 0.1);
    }

    .replacement-modal .close-modal-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .replacement-modal .close-modal-btn:hover {
      background: var(--accent);
    }

    .recipe-details {
      color: var(--text);
    }

    .macro-info {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .macro-info span {
      background: rgba(81, 186, 173, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .dietary-tags {
      margin: 10px 0;
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-right: 5px;
    }

    .tag.vegetarian {
      background: #a3c962;
      color: #062a39;
    }

    .tag.vegan {
      background: #51baad;
      color: #ffffff;
    }

    .view-recipe-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 10px;
      width: 100%;
    }

    .view-recipe-btn:hover {
      background: var(--accent);
    }

    /* Recipe Modal */
    .recipe-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .recipe-modal-content {
      background: var(--card-bg);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      border-radius: 8px;
      padding: 20px;
      position: relative;
      overflow-y: auto;
    }

    .recipe-modal-content h2 {
      color: var(--text);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
    }

    .recipe-modal-body {
      color: var(--text);
    }

    .recipe-info {
      margin-bottom: 20px;
      padding: 10px;
      background: rgba(81, 186, 173, 0.1);
      border-radius: 4px;
    }

    .recipe-modal-body h3 {
      color: var(--text);
      margin: 15px 0 10px;
    }

    .recipe-modal-body ul {
      list-style-type: none;
      padding-left: 0;
    }

    .recipe-modal-body li {
      padding: 5px 0;
      border-bottom: 1px solid rgba(81, 186, 173, 0.1);
    }

    .recipe-modal-body .instructions {
      white-space: pre-line;
      line-height: 1.6;
    }

    .close-modal-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .close-modal-btn:hover {
      background: var(--accent);
    }

    .meal-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .meal-image:hover {
      transform: scale(1.02);
    }

    .meal-card .recipe-details {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .meal-header {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--secondary);
    }

    .macros {
      margin: 10px 0;
      padding: 10px;
      background: var(--highlight);
      border-radius: 5px;
    }

    .ingredients {
      margin-top: 10px;
      padding: 10px;
      border-top: 1px solid var(--accent);
    }

    .meal-card .view-recipe-btn {
      margin-top: auto;
    }

    @media (max-width: 768px) {
      #replacementMeal {
        grid-template-columns: 1fr;
      }
    }

    /* Add/Remove Buttons */
    .add-button, .remove-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-button svg {
      stroke: var(--primary);
      fill: none;
    }

    .add-button:hover svg {
      stroke: var(--accent);
    }

    .remove-button {
      font-size: 1.5em;
      color: var(--primary);
    }

    .remove-button:hover {
      color: var(--accent);
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text);
      font-style: italic;
      animation: pulse 2s infinite;
    }

    /* Saved Meals */
    .saved-meal {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(20px);
      cursor: pointer;
    }

    .saved-meal:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-color: var(--accent);
    }

    .saved-meal h3 {
      color: var(--text);
      margin-bottom: 10px;
      font-size: 1.1em;
      padding-right: 30px;
    }

    .saved-meal-details {
      font-size: 0.9em;
      color: var(--text);
    }

    .saved-meal-details p {
      margin: 5px 0;
    }

    .saved-meal-preview {
      color: var(--accent);
      font-size: 0.8em;
      margin-top: 10px;
      text-align: center;
      opacity: 0.8;
    }

    .saved-meal:hover .saved-meal-preview {
      opacity: 1;
      color: var(--primary);
    }

    /* Save and Remove Buttons */
    .save-meal-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--card-bg);
      border: none;
      cursor: pointer;
      padding: 5px;
      color: var(--primary);
      transition: all 0.3s ease;
      z-index: 1;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .save-meal-btn:hover {
      color: var(--accent);
      transform: scale(1.1);
      background: var(--highlight);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    .save-meal-btn svg {
      width: 24px;
      height: 24px;
      stroke-width: 2.5;
    }

    .remove-meal-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: var(--primary);
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      transition: all 0.3s ease;
      line-height: 1;
      z-index: 2;
    }

    .remove-meal-btn:hover {
      color: var(--accent);
      transform: scale(1.1);
    }

    /* Saved meal modal styles */
    .saved-meal-modal .recipe-modal-content {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .saved-meal-modal .recipe-info {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .saved-meal-modal .ingredients-section,
    .saved-meal-modal .instructions-section {
      margin: 20px 0;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .saved-meal-modal .ingredients-section ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }

    .saved-meal-modal .ingredients-section li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(81, 186, 173, 0.1);
    }

    .saved-meal-modal .instructions {
      line-height: 1.6;
      white-space: pre-line;
    }

    .saved-meal-modal .dietary-tags {
      margin: 15px 0;
    }

    .saved-meal-modal .macro-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .saved-meal-modal .macro-info p {
      background: rgba(81, 186, 173, 0.1);
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }

    /* Cook's Notes section styling for modals */
    .cooks-notes-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(81, 186, 173, 0.1);
      border-left: 4px solid var(--accent);
      border-radius: 4px;
    }

    .cooks-notes-section h3 {
      margin: 0 0 10px 0;
      color: var(--accent);
      font-size: 1.1em;
      font-weight: bold;
    }

    .cooks-notes-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .cooks-notes-section li {
      padding: 8px 0;
      color: var(--text);
      line-height: 1.5;
      position: relative;
      padding-left: 20px;
    }

    .cooks-notes-section li::before {
      content: "💡";
      position: absolute;
      left: 0;
      top: 8px;
      font-size: 1em;
    }

    /* Section Headers */
    section h2 {
      color: var(--secondary);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-wrapper {
        flex-direction: column;
      }

      #savedMealsPanel {
        width: 100%;
        border-right: none;
        border-bottom: 2px solid var(--accent);
        max-height: 200px;
      }

      #rightToolsPanel {
        width: 100%;
        border-left: none;
        border-top: 2px solid var(--accent);
        max-height: 300px;
      }

      #replacementMeal {
        flex-direction: column;
        align-items: center;
      }

      .meal-card {
        min-width: 280px !important;
        max-width: 100% !important;
        margin: 10px 0 !important;
      }

      .food-selection {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .preference-selection {
        flex-direction: column;
      }

      .header-content {
        gap: 10px;
      }

      .logo {
        height: 30px;
      }

      header h1 {
        font-size: 1.4em;
      }

      .meal-image {
        height: 150px;
      }

      .recipe-modal-image {
        height: 200px;
      }
    }

    /* Medium screens - stack panels vertically but keep cards horizontal */
    @media (max-width: 1024px) and (min-width: 769px) {
      .meal-card {
        min-width: 250px;
        max-width: 300px;
      }
      
      #replacementMeal {
        gap: 8px;
      }
    }

    /* Add CSS for dietary tags */
    .dietary-tag {
      display: inline-block;
      padding: 3px 8px;
      margin-left: 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .dietary-tag.vegan {
      background: #51baad;
      color: white;
    }

    .dietary-tag.vegetarian {
      background: #a3c962;
      color: white;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
      width: 100%;
      padding: 0 20px;
    }

    .logo {
      height: 55px;
      width: auto;
      object-fit: contain;
    }

    /* Add CSS for the authentication logo */
    .auth-logo {
      width: 200px;
      height: auto;
      margin-bottom: 20px;
      object-fit: contain;
    }

    /* Add CSS for meal card animations */
    .meal-card {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    }

    .meal-card.show {
      opacity: 1;
      transform: translateY(0);
    }

    .meal-card .ingredients ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      display: block;
    }

    .meal-card .ingredients li {
      padding: 4px 0;
      margin: 0;
      word-wrap: break-word;
      position: relative;
      line-height: 1.4;
      display: block;
      width: 100%;
    }

    /* Regular ingredient items with proper bullet spacing */
    .meal-card .ingredients li:not(.ingredient-section-header) {
      padding-left: 20px;
      position: relative;
    }

    .meal-card .ingredients li:not(.ingredient-section-header)::before {
      content: "•";
      position: absolute;
      left: 0;
      top: 4px;
      color: var(--accent);
      font-weight: bold;
    }

    /* Section headers with enhanced styling */
    .ingredient-section-header {
      list-style: none !important;
      font-weight: bold !important;
      color: var(--secondary) !important;
      margin: 20px 0 10px 0 !important;
      padding: 10px 15px !important;
      background: linear-gradient(135deg, rgba(81, 186, 173, 0.15), rgba(81, 186, 173, 0.05)) !important;
      border-left: 5px solid var(--accent) !important;
      border-radius: 6px !important;
      border-bottom: none !important;
      font-size: 1em !important;
      text-transform: capitalize !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
      position: relative !important;
    }

    .ingredient-section-header::before {
      content: none !important;
    }

    /* Ingredients under sections get extra indentation */
    .ingredient-section-header + li:not(.ingredient-section-header),
    .ingredient-section-header + li:not(.ingredient-section-header) ~ li:not(.ingredient-section-header) {
      margin-left: 25px !important;
      padding-left: 20px !important;
      border-left: 2px solid rgba(81, 186, 173, 0.2) !important;
      padding-top: 6px !important;
      padding-bottom: 6px !important;
    }

    /* Reset indentation when we hit a new section */
    .ingredient-section-header + li.ingredient-section-header {
      margin-left: 0 !important;
    }

    /* Empty line spacing */
    .meal-card .ingredients li[style*="height: 8px"] {
      height: 12px !important;
      margin: 8px 0 !important;
      border: none !important;
    }

    /* Trigger warning labels */
    .ingredient-warning {
      display: inline-block;
      font-size: 0.75em;
      padding: 2px 6px;
      margin-left: 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .ingredient-warning.contains {
      background-color: rgba(255, 68, 68, 0.15);
      color: #ff4444;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }

    .ingredient-warning.mayContain {
      background-color: rgba(255, 187, 51, 0.15);
      color: #ffbb33;
      border: 1px solid rgba(255, 187, 51, 0.3);
    }

    @media (max-width: 480px) {
      .meal-card .ingredients li {
        flex: 0 0 100%;
      }
    }

    /* Add CSS for collapsible meal cards */
    .meal-card .ingredients.collapsed {
      max-height: 150px;
      overflow: hidden;
      position: relative;
    }

    .meal-card .ingredients.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: linear-gradient(transparent, var(--background));
    }

    .toggle-recipe {
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .toggle-recipe:hover {
      color: var(--primary);
    }

    .toggle-recipe .icon {
      display: inline-block;
      margin-left: 5px;
      transition: transform 0.3s ease;
    }

    .toggle-recipe.expanded .icon {
      transform: rotate(180deg);
    }

    /* Add CSS for recipe form */
    .recipe-form {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: var(--background);
      border-radius: 8px;
      border: 2px solid var(--primary);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text);
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="url"],
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--card-bg);
      color: var(--text);
    }

    .dietary-options {
      display: flex;
      gap: 20px;
    }

    .dietary-options label {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .submit-recipe {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .submit-recipe:hover {
      background: var(--primary);
    }

    /* Add animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text);
      font-style: italic;
      animation: pulse 2s infinite;
    }

    .replacement-card {
      opacity: 0;
      transform: translateY(20px);
    }

    .replacement-card.show {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }

    /* Update loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    /* Recipe Images */
    .recipe-modal-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Add CSS for ingredient warnings */
    .ingredient-warning {
      display: inline-block;
      font-size: 0.8em;
      padding: 2px 6px;
      margin-left: 8px;
      border-radius: 4px;
    }

    .ingredient-warning.contains {
      background-color: #ff6b6b;
      color: white;
    }

    .ingredient-warning.mayContain {
      background-color: #ffd93d;
      color: black;
    }

    /* Add styles for trigger warnings and substitutions */
    .trigger-warning {
      background-color: rgba(255, 107, 107, 0.1);
      border-left: 3px solid #ff6b6b;
      padding: 8px 12px;
      margin: 10px 0;
      border-radius: 0 4px 4px 0;
    }

    .trigger-warning p {
      margin: 0;
      color: #ff6b6b;
      font-size: 0.9em;
    }

    .substitutions-section {
      background-color: rgba(81, 186, 173, 0.1);
      border-radius: 4px;
      padding: 12px;
      margin: 10px 0;
    }

    .substitutions-section h4 {
      color: var(--accent);
      margin: 0 0 8px 0;
      font-size: 0.95em;
    }

    .substitutions-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .substitutions-section > ul > li {
      margin-bottom: 12px;
      font-size: 0.9em;
    }

    .substitutions-section ul ul {
      margin-top: 4px;
      margin-left: 16px;
    }

    .substitutions-section ul ul li {
      color: var(--accent);
      padding: 2px 0;
      position: relative;
    }

    .substitutions-section ul ul li:before {
      content: "•";
      position: absolute;
      left: -12px;
      color: var(--accent);
    }

    /* Add CSS to improve modal interaction */
    .recipe-modal, .replacement-modal {
      cursor: pointer;
    }
    
    .recipe-modal-content, .replacement-modal-content {
      cursor: default;
    }

    /* Add styles for trigger food labels */
    .trigger-label {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-left: 8px;
      font-weight: 500;
    }

    .trigger-label.contains {
      background-color: rgba(255, 0, 0, 0.1);
      color: #ff4444;
      border: 1px solid #ff4444;
    }

    .trigger-label.may-contain {
      background-color: rgba(255, 255, 0, 0.1);
      color: #ffbb33;
      border: 1px solid #ffbb33;
    }

    /* Add styling for meal card save button */
    .meal-card .save-meal-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .meal-card .save-meal-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
    }

    /* Loading notification styles */
    .notification.loading {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 15px 20px;
    }

    .notification.loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    /* Ensure numbered instructions display properly */
    .meal-card .recipe ol,
    .recipe-modal-body .instructions ol,
    .saved-meal-modal .instructions ol,
    .instructions-section ol {
      list-style-type: decimal !important;
      padding-left: 20px !important;
      margin: 0 !important;
    }

    .meal-card .recipe ol li,
    .recipe-modal-body .instructions ol li,
    .saved-meal-modal .instructions ol li,
    .instructions-section ol li {
      padding: 5px 0 !important;
      margin: 0 !important;
      border-bottom: none !important;
      display: list-item !important;
    }

    /* Ingredient Checker Styles */
    #ingredientChecker {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
    }

    #ingredientResults {
      min-height: 50px;
    }

    .ingredient-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid;
    }

    .ingredient-result.safe {
      background: rgba(163, 201, 98, 0.1);
      border-color: #a3c962;
      color: var(--text);
    }

    .ingredient-result.warning {
      background: rgba(255, 187, 51, 0.1);
      border-color: #ffbb33;
      color: var(--text);
    }

    .ingredient-result.danger {
      background: rgba(255, 68, 68, 0.1);
      border-color: #ff4444;
      color: var(--text);
    }

    .ingredient-result h4 {
      margin: 0 0 5px 0;
      font-size: 0.9em;
    }

    .ingredient-result p {
      margin: 0;
      font-size: 0.8em;
    }

    /* Hidden Trigger Detector Styles */
    #hiddenTriggerDetector {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
    }

    .trigger-category {
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    .trigger-category-header {
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .trigger-category-content {
      padding: 10px 12px;
      background: var(--background);
      display: none;
    }

    .trigger-category-content.expanded {
      display: block;
    }

    .hidden-food-item {
      padding: 5px 0;
      font-size: 0.85em;
      border-bottom: 1px solid rgba(81, 186, 173, 0.1);
    }

    .hidden-food-item:last-child {
      border-bottom: none;
    }

    .expand-icon {
      transition: transform 0.3s ease;
    }

    .expand-icon.rotated {
      transform: rotate(180deg);
    }

    /* Add styles for ingredient section headers */
    .ingredient-section-header {
      list-style: none !important;
      font-weight: bold !important;
      color: var(--accent) !important;
      margin-top: 15px !important;
      margin-bottom: 8px !important;
      padding: 8px 12px !important;
      background: rgba(81, 186, 173, 0.1) !important;
      border-left: 4px solid var(--accent) !important;
      border-radius: 4px !important;
      border-bottom: none !important;
      font-size: 0.95em !important;
    }

    .ingredient-section-header + li {
      margin-top: 5px !important;
    }

    /* Improve ingredient list spacing */
    .meal-card .ingredients ul li {
      padding: 4px 0;
      line-height: 1.4;
    }

    .meal-card .ingredients ul li.ingredient-section-header + li {
      margin-left: 20px;
    }

    .ingredient-spacer {
      height: 8px;
      border-bottom: 1px solid rgba(81, 186, 173, 0.2);
      list-style: none !important;
      margin: 8px 0 !important;
    }

    .ingredient-item {
      padding: 4px 0;
      line-height: 1.4;
    }

    .ingredient-under-section {
      padding-left: 20px;
      border-left: 2px solid rgba(81, 186, 173, 0.2);
      margin-left: 10px;
      padding-top: 6px;
      padding-bottom: 6px;
    }
  </style>
</head>
<body>
  <div id="verificationOverlay" class="verification-overlay">
    <div class="form" id="verificationForm">
      <img src="inFoods Logo.png" alt="inFoods Logo" class="auth-logo">
      <div class="info">
        <span class="title">Trigger Food Navigator</span>
        <p class="description">Enter your 7-character verification code to access the meal planner.</p>
      </div>
      <div class="input-fields">
        <input type="text" maxlength="1" data-index="0" aria-label="First character">
        <input type="text" maxlength="1" data-index="1" aria-label="Second character">
        <input type="text" maxlength="1" data-index="2" aria-label="Third character">
        <input type="text" maxlength="1" data-index="3" aria-label="Fourth character">
        <input type="text" maxlength="1" data-index="4" aria-label="Fifth character">
        <input type="text" maxlength="1" data-index="5" aria-label="Sixth character">
        <input type="text" maxlength="1" data-index="6" aria-label="Seventh character">
      </div>
      <div class="verification-message" id="verificationMessage"></div>
      <div class="action-btns">
        <button type="button" class="verify" id="verifyBtn">Verify</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="main-content-hidden">
  <!-- Header with Theme Toggle -->
  <header>
    <div class="header-content">
      <a href="https://www.infoodsibs.com/" target="_blank" rel="noopener noreferrer">
        <img src="inFoods Logo.png" alt="inFoods Logo" class="logo">
      </a>
      <h1>Trigger Food Navigator</h1>
    </div>
    <div class="theme-switch" onclick="toggleTheme()">
      <span id="theme-icon">☀️</span>
      <span id="theme-text">Light Mode</span>
    </div>
  </header>
      
  <div class="main-wrapper">
    <!-- Left Sidebar: My Saved Meals -->
    <aside id="savedMealsPanel">
      <h2>My Saved Meals</h2>
      <button id="exportMealsPDFBtn" style="margin-bottom: 10px;">Export as PDF</button>
      <div id="savedMeals">
        <!-- Saved meal boxes will be appended here -->
      </div>
    </aside>
    
    <!-- Center Main Content -->
    <main id="mainContentInner">
      <section id="layer1">
                        <h2>Positive Trigger Foods</h2>
        <div class="food-selection" id="foodSelection">
          <!-- Food items inserted via JavaScript -->
        </div>
      </section>

      <!-- Dietary Preference Section -->
      <section id="dietaryPreferences">
        <h2>Dietary Preferences</h2>
        <div class="preference-selection">
          <div class="preference-option">
            <input type="radio" id="no-preference" name="diet-preference" value="none" checked>
            <label for="no-preference">No Dietary Restrictions</label>
          </div>
          <div class="preference-option">
            <input type="radio" id="vegetarian" name="diet-preference" value="vegetarian">
            <label for="vegetarian">Vegetarian</label>
          </div>
          <div class="preference-option">
            <input type="radio" id="vegan" name="diet-preference" value="vegan">
            <label for="vegan">Vegan</label>
          </div>
        </div>
      </section>
  
      <div class="button-group">
        <button id="resetBtn">Reset Selections</button>
        <button id="fetchRecipesBtn" class="fetch-recipes-btn">
          <span>Find Replacement Meals</span>
          <div class="loading-spinner"></div>
        </button>
      </div>
  
      <section id="layer2">
        <h2>Replacement Suggestions</h2>
        <div class="replacement-display" id="replacementDisplay">
          <!-- Replacement cards inserted via JavaScript -->
        </div>
      </section>
  
      <section id="replacementMealSection">
        <h2>Popular Recipes (These Recipes Exclude or Identify Trigger Foods)</h2>
        <div id="replacementMeal">
          <!-- Generated replacement meal card will be displayed here -->
        </div>
      </section>
    </main>

    <!-- Right Panel: Analysis Tools -->
    <aside id="rightToolsPanel">
      <div id="ingredientChecker">
        <h2>🔍 Ingredient Checker</h2>
        <p style="font-size: 0.9em; color: var(--text); margin-bottom: 15px;">
          Enter any ingredient or food item to check for trigger foods (e.g. Chocolate, Ketchup, Croutons)
        </p>
        <div style="margin-bottom: 15px;">
          <input type="text" id="ingredientInput" placeholder="Enter ingredient (e.g., wheat flour, mayonnaise, chocolate)" 
                 style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text);">
        </div>
        <div id="ingredientResults"></div>
      </div>

      <div id="hiddenTriggerDetector">
        <h2>⚠️ Hidden Trigger Foods</h2>
        <p style="font-size: 0.9em; color: var(--text); margin-bottom: 15px;">
          Foods that unexpectedly contain your trigger ingredients
        </p>
        <div id="hiddenTriggersList"></div>
      </div>
    </aside>
  </div>
      
  <script>
    // Data Definitions
    const triggerFoods = [
      "Walnut", "Corn", "Black Tea", "Cabbage", "Cocoa", "Egg", "Grapefruit", "Honey",
      "Lemon", "Milk", "Oat", "Orange", "Pineapple", "Rye", "Soybean", "Sugar", "Wheat", "Yeast"
    ];

    // Add hidden condiment trigger foods for backend processing
    const hiddenTriggerFoods = ["Ketchup", "Mayonnaise", "Mustard"];

    const replacementMapping = {
      "Walnut": [
        "Seed alternatives:",
        "- Sunflower seeds - Rich in vitamin E and healthy fats",
        "- Pumpkin seeds - High in minerals and protein",
        "- Chia seeds - Rich in omega-3 fatty acids",
        "- Sesame seeds - Good source of calcium and iron",
        "",
        "Nut alternatives:",
        "- Macadamia nuts - Rich, buttery flavor",
        "- Pine nuts - Delicate, sweet flavor",
        "- Peanuts - High protein option",
        "",
        "Butter alternatives:",
        "- Sunflower seed butter - Smooth, nutty spread",
        "- Peanut butter - Classic protein-rich spread"
      ],
      "Corn": [
        "Whole Corn Kernels replacements:",
        "- Peas - Similar sweetness and texture",
        "- Diced Carrots - Adds sweetness and similar bite",
        "- Edamame (Soybeans) - Adds protein, mild sweetness, and similar texture",
        "- Chopped Zucchini or Yellow Squash - Good texture replacement with mild flavor",
        "",
        "Cornstarch (for thickening) replacements:",
        "- Potato Starch (1:1 ratio) - Excellent thickener, neutral flavor",
        "- Arrowroot Powder (1:1 ratio) - Great for sauces, glossy finish",
        "- Tapioca Starch (2 tsp tapioca : 1 tbsp cornstarch) - Ideal for pie fillings and sauces",
        "- All-Purpose Flour (2 tbsp flour : 1 tbsp cornstarch) - Common pantry staple; may require longer cooking",
        "",
        "Cornmeal replacements:",
        "- Semolina Flour - Similar texture, slightly coarser, ideal for baking",
        "- Polenta - Almost identical, slightly coarser grind",
        "- Breadcrumbs or Panko - Good for breading, coating, or crunchy toppings",
        "- Ground Oats or Oat Flour - Slightly different flavor, but similar texture in baked goods",
        "",
        "Corn Flour replacements:",
        "- Rice Flour (1:1 ratio) - Similar fine texture, gluten-free",
        "- Almond Flour (1:1 ratio) - Adds nutty flavor, gluten-free alternative",
        "- Wheat Flour (1:1 ratio) - Works for baking, but texture and flavor differ slightly",
        "",
        "Corn Syrup replacements:",
        "- Cane Sugar (1:1 ratio) - Traditional sweetener with similar sweetness level",
        "- Honey (1:1 ratio) - Richer flavor, more sweetness",
        "- Maple Syrup (1:1 ratio) - Adds distinct flavor, works in many recipes",
        "- Brown Rice Syrup (1:1 ratio) - Neutral taste, similar consistency",
        "- Simple Sugar Syrup - Equal sugar and water boiled, easy homemade alternative",
        "",
        "Popcorn replacements:",
        "- Puffed Rice or Millet - Light, crunchy snacks, ideal as a popcorn alternative",
        "- Roasted Chickpeas - Crunchy, savory snack, high in protein",
        "- Rice Cakes or Puffed Rice Cakes - Similar crispy snack with neutral taste"
      ],
      "Black Tea": [
        "Herbal Tea Options:",
        "- Peppermint tea - Refreshing and caffeine-free",
        "- Ginger tea - Spicy and warming",
        "- Chamomile tea - Calming and soothing",
        "- Rooibos tea - Naturally caffeine-free with nutty flavor",
        "- Hibiscus tea - Tart and fruity",
        "",
        "Other Tea Varieties:",
        "- Green tea - Lower caffeine content than black tea",
        "- Matcha - Concentrated green tea powder",
        "- Oolong tea - Semi-oxidized tea with complex flavor",
        "",
        "Energy-Boosting Alternative:",
        "- Yerba Mate - Natural energy boost with nutrients",
        "",
        "Note: Some alternatives like green tea, oolong tea, and yerba mate still contain caffeine, but generally less than black tea"
      ],
      "Cabbage": [
        "For Cooked Uses (stir-fries, soups):",
        "- Bok Choy - Closest texture and flavor, mild and crisp",
        "- Swiss Chard - Earthy taste, wilts similarly to cabbage",
        "- Collard Greens - Slightly bitter, ideal for soups or stews",
        "- Spinach - Softer texture, cooks faster; good in stir-fries or soups",
        "",
        "For Fermentation & Pickling (kimchi, sauerkraut):",
        "- Napa Cabbage (Chinese cabbage) - Most common kimchi ingredient, mild flavor",
        "- Daikon Radish - Adds crunch and mild spiciness when fermented",
        "- Turnips - Slightly sweet and peppery flavor, ideal for fermenting",
        "",
        "General Purpose Alternatives:",
        "- Brussels Sprouts - Similar flavor profile, works well roasted or sautéed",
        "- Broccoli - Different texture, similar flavor when cooked",
        "- Cauliflower - Mild taste, versatile in cooking"
      ],
      "Cocoa": [
        "Direct substitutes:",
        "- Carob powder - Natural chocolate alternative, slightly sweeter than cocoa",
        "",
        "Alternative dessert options:",
        "- Vanilla flavoring - Classic alternative flavor",
        "- Carrot-based desserts - Naturally sweet and moist",
        "- Fruit-flavored desserts - Various options using fresh fruits",
        "- Coconut-flavored desserts - Rich, tropical alternative",
        "- Fruit cheesecakes and pies - Naturally sweet options",
        "- Oatmeal cookies - Classic cookie alternative",
        "- Graham crackers - Simple sweet snack option",
        "",
        "Note: When using carob powder as a substitute for cocoa, use a 1:1 ratio but reduce sugar in recipe as carob is naturally sweeter"
      ],
      "Egg": [
        "For binding (1 egg = any of these):",
        "- ¼ cup potato starch",
        "- ¼ cup pureed fruit",
        "- ¼ cup mashed banana",
        "- ¼ cup applesauce",
        "- ¼ cup pumpkin puree",
        "- Flaxseed egg (1 tbsp ground flaxseed + 3 tbsp room temp water, let sit 5 min)",
        "",
        "For leavening (1 egg = this combination):",
        "- 1 teaspoon baking soda + 1 tablespoon white vinegar",
        "",
        "For cooking:",
        "- Firm tofu (crumbled for scrambles)",
        "- Commercial plant-based liquid egg alternatives",
        "",
        "For meringue and whipping:",
        "- Aquafaba (liquid from canned chickpeas)",
        "- 3 tablespoons aquafaba = 1 egg",
        "",
        "Note: Choose the substitute based on the egg's purpose in your recipe. Binding substitutes work best in baked goods, leavening substitutes help create rise, and aquafaba is ideal for meringues and other whipped applications."
      ],
      "Grapefruit": [
        "Pineapple - Fresh fruit replacement",
        "Mango - Fresh fruit replacement",
        "Pomegranate - Fresh fruit replacement",
        "Cranberry - Fresh fruit replacement",
        "Pineapple juice - For juice replacement",
        "Mango juice - For juice replacement",
        "Cranberry juice - For juice replacement",
        "Pomegranate juice - For juice replacement",
        "Non-citrus alternatives:",
        "- Kiwi fruit",
        "- Apple",
        "- Banana",
        "- Passion fruit",
        "- Grapes",
        "- Papaya"
      ],
      "Honey": [
        "Liquid sweetener alternatives:",
        "- Maple syrup - Rich flavor, 1:1 replacement ratio",
        "- Agave nectar - Mild flavor, 1:1 replacement ratio",
        "- Corn syrup - Neutral flavor, 1:1 replacement ratio",
        "- Molasses - Rich, dark flavor, 1:1 replacement ratio",
        "- Date syrup - Natural sweetness, 1:1 replacement ratio",
        "",
        "Granulated alternatives:",
        "- Brown sugar - Dissolve in warm liquid first, use ¾ cup + ¼ cup water per 1 cup honey",
        "",
        "Natural fruit alternatives:",
        "- Fruit puree - Natural sweetness, great for baking",
        "- Mashed ripe banana - Works well in baked goods, adds moisture",
        "",
        "Note: When substituting honey in baking, reduce oven temperature by 25°F to prevent over-browning"
      ],
      "Lemon": [
        "Non-citrus fruit alternatives:",
        "- Kiwi fruit",
        "- Pineapple",
        "- Banana",
        "- Passion fruit",
        "- Grapes",
        "- Mango",
        "- Papaya",
        "For zest replacement:",
        "- Ginger zest",
        "For baking:",
        "- Cream of tartar",
        "For vinegar replacement:",
        "- Lemon juice (1:1 ratio) - Similar acidity and tang"
      ],
      "Milk": [
        "Plant-Based Milk Alternatives:",
        "- Almond milk - Light, nutty flavor",
        "- Cashew milk - Creamy, mild flavor",
        "- Coconut milk - Rich, tropical flavor",
        "- Flax milk - Light, neutral taste",
        "- Hemp milk - Nutty, earthy flavor",
        "- Macadamia milk - Rich, buttery taste",
        "- Oat milk - Sweet, mild flavor",
        "- Pea protein milk - Neutral taste, high protein",
        "- Rice milk - Light, sweet taste",
        "- Soy milk - Rich, full-bodied flavor",
        "",
        "Dairy-Free Products:",
        "- Almond yogurt/ice cream",
        "- Cashew yogurt/ice cream",
        "- Coconut yogurt/ice cream",
        "- Oat yogurt/ice cream",
        "- Rice ice cream",
        "- Soy yogurt/ice cream/cheese",
        "- Vegan cheese products",
        "",
        "Dairy Substitution Ratios:",
        "- 1 cup whole milk = ½ cup rice milk + ½ cup water",
        "- 1 cup skim milk = 1 cup rice or coconut milk",
        "- 1 ounce cheese = 1 ounce non-dairy cheese",
        "- 1 Tbsp cream cheese = 1 Tbsp dairy-free cream cheese",
        "- 1 cup butter = ¾ cup olive oil OR 1 cup mashed banana OR 1 cup dairy-free, soy-free margarine",
        "- 1 cup heavy cream = ⅔ cup rice milk + ⅓ cup canola or corn oil",
        "- 1 cup light cream = ¾ cup rice milk + ¼ cup canola or corn oil",
        "- 1 cup buttermilk = 1 cup rice milk + 1 Tbsp lemon juice",
        "- 1 cup yogurt = 1 cup dairy-free yogurt OR 1 cup applesauce",
        "",
        "Important Notes:",
        "- Avoid milk from all domestic animals (including goat's milk)",
        "- Lactose-free products still contain milk proteins (casein, whey) and should be avoided",
        "",
        "Safe Ingredients (do not contain milk protein):",
        "- Calcium lactate",
        "- Cocoa butter",
        "- Cream of tartar",
        "- Lactic acid",
        "- Oleoresin",
        "- Sodium stearoyl lactate"
      ],
      "Oat": [
        "Breakfast alternatives:",
        "- Cream of wheat - Smooth, creamy hot cereal",
        "- Cream of rice - Gentle on digestion, mild flavor",
        "- Grits - Southern-style breakfast alternative",
        "- Buckwheat - Nutty flavor, great for porridge",
        "",
        "Grain alternatives:",
        "- Millet - Light, mild flavor with good protein content",
        "- Sorghum - Gluten-free grain with nutty flavor",
        "- Quinoa - High-protein complete grain",
        "- Rice - Versatile, easily digestible grain",
        "- Polenta - Corn-based alternative with creamy texture",
        "- Buckwheat - Versatile pseudo-grain",
        "- Teff - Ancient grain high in nutrients",
        "",
        "Flour alternatives for baking:",
        "- Rice flour - Light texture, neutral taste",
        "- Wheat flour - Traditional baking alternative",
        "- Cassava flour - Root-based alternative",
        "- Almond flour - Nutty flavor, good for low-carb baking",
        "- Coconut flour - Sweet flavor, high fiber",
        "- Flax meal - Good for binding in recipes",
        "- Chia seed meal - Excellent egg replacer in baking"
      ],
      "Orange": [
        "Non-citrus fruit alternatives:",
        "- Kiwi fruit",
        "- Strawberries",
        "- Pineapple",
        "- Banana",
        "- Passion fruit",
        "- Grapes",
        "- Mango",
        "- Papaya",
        "Note: Avoid all citrus alternatives including tangerines, mandarins, and blood orange"
      ],
      "Pineapple": [
        "Fresh fruit alternatives:",
        "- Pears - Mild, sweet flavor",
        "- Grapes - Sweet and juicy",
        "- Apples - Crisp and refreshing",
        "- Blueberries - Antioxidant-rich alternative",
        "- Papaya - Tropical sweetness",
        "",
        "Juice alternatives:",
        "- Cranberry juice - Tart alternative",
        "",
        "Additional options:",
        "- Mango - Similar tropical flavor",
        "- Kiwi - Tangy and sweet"
      ],
      "Rye": [
        "Bread alternatives:",
        "- Sourdough bread - Traditional fermented bread with complex flavor",
        "- French bread - Classic white bread with crispy crust",
        "- Focaccia bread - Italian flatbread with herbs and olive oil",
        "- Italian bread - Crusty bread with soft interior",
        "- White bread - Basic alternative for sandwiches and toast",
        "",
        "Gluten-free bread alternatives:",
        "- Gluten-free breads - Made with alternative flours",
        "- Gluten-free baked goods - Including muffins, cookies, cakes",
        "- Gluten-free crackers - Various types made without rye",
        "- Gluten-free baking mixes - For homemade bread and pastries",
        "",
        "Grain and flour alternatives:",
        "- Almond meal - Nutty flavor, great for baking",
        "- Amaranth flour - High in protein, slightly sweet",
        "- Buckwheat flour - Earthy flavor, good for pancakes and breads",
        "- Cassava flour - Neutral taste, good all-purpose substitute",
        "- Chickpea flour - High protein, good for savory baked goods",
        "",
        "Corn-based alternatives (if corn is not a trigger):",
        "- Corn tortillas - Flexible alternative for wraps and tacos",
        "- Grits - Southern-style breakfast dish",
        "- Tortilla chips - Crunchy snack option",
        "",
        "Rice-based alternatives:",
        "- Rice flour - Neutral taste, good all-purpose substitute",
        "- Rice cakes - Light, crunchy snack option",
        "- Soba noodles - Japanese buckwheat noodles (check ingredients for wheat)",
        "",
        "Other alternatives:",
        "- Quinoa - High protein grain alternative",
        "- Sweet potatoes - Versatile starchy alternative",
        "- Potato-based products - Including chips and other snacks",
        "- Gluten-free oatmeal - Check for certified gluten-free labeling"
      ],
      "Soybean": [
        "Legume alternatives:",
        "- Chickpeas - High in protein and fiber",
        "- Lentils - Quick-cooking, protein-rich option",
        "- Kidney beans - Hearty texture, good for stews and chili",
        "- Pinto beans - Creamy texture, great for refried beans",
        "- Peas - Sweet, fresh alternative",
        "- Fava beans - Buttery, rich in nutrients",
        "",
        "Oil alternatives:",
        "- Pure olive oil - Heart-healthy cooking oil",
        "- Avocado oil - High heat cooking oil",
        "- Coconut oil - Good for baking and cooking",
        "- Algae oil - Rich in omega-3",
        "- Ghee - Clarified butter, good for high-heat cooking",
        "- Butter - Traditional cooking fat",
        "",
        "Sauce alternatives:",
        "- Coconut aminos - 1:1 replacement for soy sauce"
      ],
      "Sugar": [
        "Natural liquid sweeteners:",
        "- Honey - Rich flavor, natural antibacterial properties",
        "- Maple syrup - Complex flavor, rich in minerals",
        "- Agave nectar - Mild flavor, dissolves easily",
        "- Date syrup - Caramel-like flavor, mineral-rich",
        "",
        "Sugar-free alternatives:",
        "- Stevia - Zero-calorie natural sweetener",
        "- Monk fruit sweetener - Zero-calorie, no aftertaste",
        "",
        "Unrefined alternatives:",
        "- Coconut sugar - Lower glycemic index, caramel flavor",
        "",
        "Note: When substituting liquid sweeteners for granulated sugar, reduce other liquid in recipe by ¼ cup for each cup of liquid sweetener used"
      ],
      "Wheat": [
        "Single Ingredient Wheat Flour Substitutes:",
        "- Buckwheat Flour - Rich, earthy flavor, best for quick breads",
        "- Sorghum Flour - Mild, sweet flavor, ideal for quick breads, muffins, desserts",
        "- Amaranth Flour - Earthy, nutty flavor, perfect for pie crusts and tortillas",
        "- White Rice Flour - Neutral flavor, excellent thickener (1:1 ratio with wheat flour)",
        "- Brown Rice Flour - Hearty, nutty flavor, great for breading and thickening",
        "- Chickpea Flour - Dense texture, works well as a thickener",
        "",
        "Basic Substitution Ratios:",
        "- For thickening: 1 Tbsp wheat flour = 1 Tbsp rice flour",
        "- Alternative thickeners: 1 Tbsp wheat flour = 1 Tbsp quick cooking tapioca OR 1½ tsp corn/potato starch OR 2 Tbsp vegetable puree",
        "- General baking: 1 cup wheat flour = 1 cup corn or rice flour",
        "Note: Add ¼ tsp xanthan gum per 1 cup flour as a binder for better results",
        "",
        "Gluten-Free Flour Alternatives:",
        "- Almond meal - Nutty flavor, great for baking",
        "- Amaranth - Ancient grain with high protein content",
        "- Arrowroot - Excellent thickener",
        "- Cassava - Neutral flavor, good all-purpose substitute",
        "- Chickpea flour - High protein content",
        "- Corn flour - Versatile option",
        "- Fava bean flour - High in protein",
        "- Flaxseed meal - Adds omega-3s",
        "- Millet - Light, mild flavor",
        "- Potato starch - Great for thickening",
        "- Quinoa flour - High protein content",
        "- Soy flour - Protein-rich option",
        "- Tapioca - Good for binding",
        "- Teff - Nutrient-dense ancient grain",
        "",
        "Ready-to-Use Alternatives:",
        "- Gluten-free breads",
        "- Gluten-free cereals",
        "- Gluten-free baked goods",
        "- Gluten-free crackers",
        "- Gluten-free baking mixes",
        "- Gluten-free pasta",
        "",
        "Grain and Starch Alternatives:",
        "- Corn tortillas",
        "- Grits",
        "- Certified gluten-free oatmeal",
        "- Popcorn",
        "- Potatoes",
        "- Potato chips",
        "- Quinoa",
        "- Rice",
        "- Rice cakes",
        "- Soba noodles (check for 100% buckwheat)",
        "- Tortilla chips",
        "- Sweet potatoes"
      ],
      "Yeast": [
        "Baking Powder (1 teaspoon yeast = 1 teaspoon baking powder) - Best for quick breads, cakes, pancakes, muffins, and biscuits that don't require rising",
        "Baking Soda + Acid (½ teaspoon baking soda + ½ teaspoon acid per 1 teaspoon yeast) - Effective for quick-rise recipes, but won't replicate the exact flavor or texture of yeast",
        "Sourdough Starter (1 cup sourdough starter per 2 teaspoons yeast, reduce flour and water by ½ cup each) - Ideal for breads; imparts a tangy flavor and requires longer rising times",
        "Beer or Carbonated Soda (Equal parts beer or soda for liquid in recipe) - Works best for quick breads or recipes that don't require significant rising; adds flavor",
        "Whipped Egg Whites (2 whipped egg whites = 1 teaspoon yeast) - Provides lift and airiness in cakes, waffles, or pancakes. Won't work for bread that requires a traditional rise"
      ],
      "Ketchup": [
        "Sugar-free ketchup without corn syrup; look for monk fruit or stevia-sweetened varieties"
      ],
      "Mayonnaise": [
        "Egg-free mayonnaise without soy; avocado-oil-based vegan mayo often avoids soybeans, eggs, and sugar"
      ],
      "Mustard": [
        "Sugar-free mustard without honey; stone-ground mustard often avoids added sweeteners"
      ]
    };

    // Add ingredient relationships data
    const ingredientRelationships = {
      "Milk": {
        directForms: [
          // Basic dairy forms
          "Milk", "Cream", "Half and half", "Heavy cream", "Light cream", "Whipping cream",
          // Cheese varieties
          "Cheese", "Cheddar", "Mozzarella", "Parmesan", "Ricotta", "Cottage cheese", 
          "Cream cheese", "Swiss cheese", "Provolone", "Gouda", "Brie", "Feta",
          "Blue cheese", "Gorgonzola", "American cheese", "Gruyere", "Manchego",
          "Shredded cheese", "Grated cheese", "Cheese blend",
          // Yogurt and fermented dairy
          "Yogurt", "Greek yogurt", "Kefir", "Sour cream", "Buttermilk",
          // Butter and derivatives
          "Butter", "Ghee", "Clarified butter", "Brown butter", "Butter solids",
          // Milk products and derivatives
          "Milk solids", "Milk powder", "Dry milk", "Evaporated milk", "Condensed milk",
          "Whey", "Whey protein", "Casein", "Caseinates", "Lactose", "Lactalbumin",
          "Lactoglobulin", "Lactoferrin", "Lactitol", "Lactylates", "Recaldent",
          // Hidden dairy ingredients
          "Curds", "Rennet casein", "Artificial butter flavor", "Natural butter flavor",
          "Milk fat", "Butter fat", "Dairy fat", "Butter oil", "Butter extract",
          // Common dairy-containing products
          "Ice cream", "Gelato", "Custard", "Pudding", "Milk chocolate",
          "White chocolate", "Hot chocolate mix", "Coffee creamer",
          // Chocolate products (many contain milk)
          "Chocolate", "Candy", "Desserts"
        ],
        mayContain: [
          // Processed foods
          "Baked goods", "Bread", "Crackers", "Cookies", "Cakes", "Pastries",
          "Pancakes", "Waffles", "Biscuits", "Muffins",
          // Prepared foods
          "Soup", "Sauce", "Gravy", "Dressing", "Marinade", "Seasoning blend",
          "Flavoring", "Natural flavoring", "Artificial flavoring",
          // Snacks and convenience foods
          "Potato chips", "Snack mix", "Granola", "Cereal", "Energy bars",
          "Protein bars", "Meal replacement shakes", "Instant meals",
          // Restaurant items
          "Breading", "Batter", "Coating", "Glazed", "Creamed", "Au gratin",
          // Chocolate products (many contain milk)
          "Chocolate", "Candy", "Desserts"
        ]
      },
      "Egg": {
        directForms: [
          // Basic forms
          "Egg", "Eggs", "Egg white", "Egg whites", "Egg yolk", "Egg yolks",
          "Whole egg", "Dried egg", "Powdered egg", "Liquid egg",
          // Specific preparations
          "Scrambled egg", "Boiled egg", "Fried egg", "Poached egg",
          "Egg wash", "Egg glaze",
          // Technical/Scientific terms
          "Albumin", "Albumen", "Globulin", "Livetin", "Ovoglobulin",
          "Ovomucin", "Ovovitellin", "Ovalbumin", "Ovotransferrin",
          "Vitellin", "Lysozyme", "Avidin",
          // Common egg-containing products
          "Mayonnaise", "Aioli", "Hollandaise", "Custard", "Meringue",
          "Egg noodles", "Egg pasta", "Egg bread", "Brioche",
          // Hidden egg ingredients
          "Lecithin (egg source)", "Egg substitutes", "Egg solids",
          "Egg powder", "Egg protein", "Egg lecithin"
        ],
        mayContain: [
          // Baked goods
          "Baked goods", "Bread", "Cake", "Cookies", "Muffins", "Pastries",
          "Pancakes", "Waffles", "Doughnuts", "Biscuits",
          // Processed foods
          "Pasta", "Noodles", "Breading", "Batter", "Coating",
          "Meatballs", "Meatloaf", "Croquettes", "Patties",
          // Desserts and sweets
          "Ice cream", "Pudding", "Custard", "Mousse", "Marshmallows",
          "Nougat", "Frosting", "Icing",
          // Sauces and dressings
          "Salad dressing", "Sauce", "Dip", "Spread",
          // Restaurant items
          "Glazed", "Battered", "Breaded", "Fried foods"
        ]
      },
      "Wheat": {
        directForms: [
          // Basic forms
          "Wheat", "Wheat flour", "All-purpose flour", "White flour",
          "Whole wheat", "Whole wheat flour", "Wheat bran", "Wheat germ",
          "Wheat starch", "Wheat protein", "Wheat gluten", "Vital wheat gluten",
          // Wheat varieties
          "Durum wheat", "Semolina", "Farina", "Graham flour",
          "Spelt", "Kamut", "Triticale", "Einkorn", "Emmer",
          // Wheat-based products
          "Bread", "Bun", "Buns", "Hamburger bun", "Hamburger buns", "Whole grain bun", "Whole grain buns", "Whole wheat bun", "Whole wheat buns", "Roll", "Rolls", "Dinner roll", "Dinner rolls", "Sandwich roll", "Sandwich rolls", "Sub roll", "Sub rolls", "Hoagie roll", "Hoagie rolls", "Kaiser roll", "Kaiser rolls", "Bagel", "Bagels", "English muffin", "English muffins", "Pita", "Flatbread", "Ciabatta", "Focaccia", "Baguette", "Brioche", "Challah",
          "Bread crumbs", "Bread flour", "Cake flour", "Pastry flour", "Self-rising flour", "Couscous", "Bulgur",
          "Pasta", "Noodles", "Spaghetti", "Macaroni", "Linguine", "Fettuccine", "Lasagna", "Ravioli", "Penne", "Rigatoni", "Farfalle", "Orzo", "Tortellini", "Gnocchi", "Tagliatelle", "Vermicelli", "Ziti", "Manicotti", "Shells", "Rotini", "Angel hair", "Elbow macaroni",
          "Panko"
        ],
        mayContain: [
          // Processed foods
          "Baked goods", "Crackers", "Cookies", "Cakes", "Pastries",
          "Cereal", "Granola", "Breakfast cereal", "Muesli",
          // Sauces and condiments
          "Soy sauce", "Teriyaki sauce", "Gravy", "Roux",
          "Seasoning mix", "Flavoring", "Natural flavoring",
          // Snacks and convenience foods
          "Snack foods", "Pretzels", "Chips", "Breading",
          "Batter", "Coating", "Thickener",
          // Restaurant items
          "Fried foods", "Battered foods", "Breaded foods"
        ]
      },
      "Sugar": {
        directForms: [
          "Sugar", "White sugar", "Brown sugar", "Raw sugar", "Cane sugar",
          "Beet sugar", "Powdered sugar", "Confectioners sugar", "Granulated sugar",
          "Superfine sugar", "Turbinado sugar", "Demerara sugar", "Muscovado sugar",
          "Sucrose", "Fructose", "Glucose", "Dextrose", "Maltose",
          "High fructose corn syrup", "Corn syrup", "Maple syrup", "Agave syrup",
          "Simple syrup", "Invert sugar", "Caramel", "Molasses"
        ],
        mayContain: [
          "Baked goods", "Desserts", "Candy", "Chocolate", "Ice cream",
          "Beverages", "Soda", "Juice", "Energy drinks", "Sports drinks",
          "Processed foods", "Sauces", "Condiments", "Marinades",
          "Breakfast cereals", "Granola bars", "Protein bars"
        ]
      },
      "Soybean": {
        directForms: [
          "Soybean", "Soybeans", "Soy beans", "Edamame", "Soy protein",
          "Soy flour", "Soy milk", "Soy sauce", "Soy oil", "Soybean oil",
          "Soy lecithin", "Tofu", "Tempeh", "Miso", "Soy nuts",
          "Soy protein isolate", "Soy protein concentrate", "Textured soy protein"
        ],
        mayContain: [
          "Vegetable oil", "Lecithin", "Protein powders", "Meat substitutes",
          "Vegetarian products", "Vegan products", "Processed foods",
          "Salad dressings", "Marinades", "Baked goods"
        ]
      },
      "Oat": {
        directForms: [
          "Oat", "Oats", "Rolled oats", "Steel cut oats", "Quick oats",
          "Old fashioned oats", "Oat flour", "Oat bran", "Oat milk",
          "Oatmeal", "Oat groats", "Oat flakes"
        ],
        mayContain: [
          "Granola", "Cereal", "Breakfast cereals", "Muesli", "Granola bars",
          "Energy bars", "Baked goods", "Bread", "Cookies", "Muffins",
          "Protein powders", "Meal replacement shakes"
        ]
      },
      "Rye": {
        directForms: [
          "Rye", "Rye flour", "Rye bread", "Rye berries", "Rye flakes",
          "Pumpernickel", "Dark rye", "Light rye", "Rye whiskey"
        ],
        mayContain: [
          "Bread", "Crackers", "Cereal", "Baked goods", "Alcoholic beverages",
          "Whiskey", "Some vodkas", "Beer"
        ]
      },
      "Yeast": {
        directForms: [
          "Yeast", "Active yeast", "Dry yeast", "Fresh yeast", "Baker's yeast",
          "Brewer's yeast", "Nutritional yeast", "Yeast extract", "Autolyzed yeast"
        ],
        mayContain: [
          "Bread", "Baked goods", "Beer", "Wine", "Fermented foods",
          "Vinegar", "Soy sauce", "Miso", "Some vitamins", "Flavor enhancers"
        ]
      },
      "Cocoa": {
        directForms: [
          "Cocoa", "Cocoa powder", "Unsweetened cocoa", "Dutch cocoa",
          "Cocoa butter", "Cacao", "Cacao powder", "Raw cacao",
          "Chocolate", "Dark chocolate", "Milk chocolate", "White chocolate",
          "Chocolate chips", "Chocolate liquor"
        ],
        mayContain: [
          "Baked goods", "Desserts", "Candy", "Ice cream", "Beverages",
          "Hot chocolate", "Chocolate milk", "Protein powders", "Energy bars"
        ]
      },
      "Lemon": {
        directForms: [
          "Lemon", "Lemon juice", "Fresh lemon juice", "Lemon zest",
          "Lemon peel", "Lemon extract", "Lemon oil", "Citric acid"
        ],
        mayContain: [
          "Beverages", "Salad dressings", "Marinades", "Sauces", "Desserts",
          "Baked goods", "Cleaning products", "Preservatives", "Flavorings"
        ]
      },
      "Orange": {
        directForms: [
          "Orange", "Orange juice", "Fresh orange juice", "Orange zest",
          "Orange peel", "Orange extract", "Orange oil", "Mandarin", "Tangerine"
        ],
        mayContain: [
          "Beverages", "Juices", "Smoothies", "Desserts", "Baked goods",
          "Marmalades", "Jams", "Sauces", "Marinades", "Flavorings"
        ]
      },
      "Pineapple": {
        directForms: [
          "Pineapple", "Fresh pineapple", "Pineapple juice", "Pineapple chunks",
          "Pineapple rings", "Crushed pineapple", "Dried pineapple"
        ],
        mayContain: [
          "Fruit salads", "Smoothies", "Juices", "Desserts", "Baked goods",
          "Pizza toppings", "Sweet and sour dishes", "Tropical dishes"
        ]
      },
      "Honey": {
        directForms: [
          "Honey", "Raw honey", "Pure honey", "Wildflower honey",
          "Clover honey", "Manuka honey", "Organic honey"
        ],
        mayContain: [
          "Baked goods", "Desserts", "Beverages", "Tea", "Granola",
          "Energy bars", "Cereals", "Sauces", "Marinades", "Dressings"
        ]
      },
      "Walnut": {
        directForms: [
          "Walnut", "Walnuts", "Walnut pieces", "Walnut halves",
          "Chopped walnuts", "Walnut oil", "Black walnuts", "English walnuts"
        ],
        mayContain: [
          "Baked goods", "Desserts", "Salads", "Trail mix", "Granola",
          "Cereals", "Nut butters", "Pesto", "Stuffing"
        ]
      },
      "Corn": {
        directForms: [
          "Corn", "Corn kernels", "Sweet corn", "Corn on the cob",
          "Cornmeal", "Cornstarch", "Corn flour", "Corn syrup",
          "High fructose corn syrup", "Corn oil", "Popcorn", "Corn chips",
          "Polenta", "Hominy", "Corn starch", "Dextrose", "Maltodextrin"
        ],
        mayContain: [
          "Processed foods", "Baked goods", "Cereals", "Snack foods",
          "Beverages", "Sauces", "Condiments", "Thickeners", "Sweeteners"
        ]
      },
      "Cabbage": {
        directForms: [
          "Cabbage", "Green cabbage", "Red cabbage", "Purple cabbage",
          "Savoy cabbage", "Napa cabbage", "Chinese cabbage", "Bok choy",
          "Sauerkraut", "Kimchi", "Coleslaw"
        ],
        mayContain: [
          "Salads", "Slaws", "Soups", "Stews", "Stir-fries",
          "Fermented foods", "Pickled vegetables", "Asian dishes"
        ]
      },
      "Grapefruit": {
        directForms: [
          "Grapefruit", "Fresh grapefruit", "Grapefruit juice", "Grapefruit segments",
          "Pink grapefruit", "White grapefruit", "Ruby red grapefruit"
        ],
        mayContain: [
          "Fruit salads", "Juices", "Smoothies", "Beverages", "Desserts",
          "Breakfast dishes", "Citrus blends"
        ]
      },
      "Black Tea": {
        directForms: [
          "Black tea", "Black tea leaves", "Black tea bags", "Earl Grey",
          "English Breakfast tea", "Assam tea", "Ceylon tea", "Darjeeling tea",
          "Orange Pekoe", "Lapsang Souchong"
        ],
        mayContain: [
          "Tea blends", "Chai", "Iced tea", "Tea extracts", "Flavored teas",
          "Beverages", "Energy drinks", "Some supplements"
        ]
      },
      "Ketchup": {
        directForms: [
          "Ketchup", "Tomato ketchup", "Catsup", "Tomato sauce (sweetened)"
        ],
        mayContain: [
          "Sugar", "Corn syrup", "High fructose corn syrup", "Corn", "Vinegar", 
          "Natural flavoring", "Spices", "Preservatives"
        ]
      },
      "Mayonnaise": {
        directForms: [
          "Mayonnaise", "Mayo", "Aioli"
        ],
        mayContain: [
          "Egg", "Egg yolk", "Oil", "Vinegar", "Sugar", "Natural flavoring"
        ]
      },
      "Mustard": {
        directForms: [
          "Mustard", "Dijon mustard", "Yellow mustard", "Whole grain mustard", 
          "Honey mustard", "Spicy mustard"
        ],
        mayContain: [
          "Sugar", "Honey", "Vinegar", "Wine", "Spices", "Natural flavoring"
        ]
      }
    };

    // Update the checkIngredientForTriggers function to be more thorough
    function checkIngredientForTriggers(ingredient, selectedTriggerFoods) {
      const ingredientLower = ingredient.toLowerCase();
      const triggers = selectedTriggerFoods.map(food => food.toLowerCase());
      
      // Helper function to check for exact word matches (not just substring matches)
      const containsExactWord = (text, word) => {
        const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
        return regex.test(text);
      };
      
      // Direct matches (Contains) - only exact matches or very specific variations
      const contains = triggers.filter(trigger => {
        // Check for direct exact word matches first
        if (containsExactWord(ingredientLower, trigger)) {
          return true;
        }
        
        // Check for specific, well-defined variations only
        const specificVariations = {
          'egg': [
            'eggs', 'egg yolk', 'egg white', 'egg powder', 'dried egg', 
            'egg albumin', 'egg protein', 'whole egg', 'fresh egg',
            'cheesecake', 'cake', 'cupcake', 'muffin', 'cookie', 'brownie',
            'custard', 'pudding', 'meringue', 'souffle'
          ],
          'milk': [
            'whole milk', 'skim milk', '2% milk', 'milk powder', 'dried milk',
            'evaporated milk', 'condensed milk', 'buttermilk', 'milk fat',
            'milk solids', 'milk protein', 'dairy', 'cream', 'butter',
            'cheese', 'yogurt', 'ice cream', 'cheesecake', 'milk chocolate',
            'white chocolate', 'custard', 'pudding', 'whipped cream'
          ],
          'wheat': [
            'wheat flour', 'whole wheat', 'wheat bread', 'wheat pasta',
            'wheat germ', 'wheat bran', 'wheat starch', 'wheat protein', 
            'wheat gluten', 'wheat berries', 'wheat groats', 'flour',
            'cake', 'cupcake', 'muffin', 'cookie', 'brownie', 'bread',
            'pasta', 'noodles', 'crackers', 'cereal'
          ],
          'sugar': [
            'white sugar', 'brown sugar', 'raw sugar', 'cane sugar', 
            'beet sugar', 'powdered sugar', 'confectioners sugar', 
            'granulated sugar', 'superfine sugar', 'cake', 'cupcake',
            'muffin', 'cookie', 'brownie', 'cheesecake', 'ice cream',
            'candy', 'chocolate', 'dessert', 'sweet'
          ],
          'soybean': [
            'soybeans', 'soy beans', 'edamame', 'soy protein', 'soy flour', 
            'soy milk', 'soy sauce', 'soy oil', 'soy lecithin', 'tofu',
            'tempeh', 'miso', 'soy nuts'
          ],
          'oat': [
            'oats', 'rolled oats', 'steel cut oats', 'oat flour', 'oat bran', 
            'oat milk', 'oatmeal', 'quick oats', 'old fashioned oats'
          ],
          'rye': [
            'rye flour', 'rye bread', 'rye berries', 'rye flakes'
          ],
          'yeast': [
            'active yeast', 'dry yeast', 'fresh yeast', 'baker\'s yeast', 
            'brewer\'s yeast', 'nutritional yeast', 'yeast extract'
          ],
          'cocoa': [
            'cocoa powder', 'unsweetened cocoa', 'dutch cocoa', 'cocoa butter',
            'cacao', 'cacao powder', 'raw cacao', 'chocolate', 'chocolate cake',
            'brownie', 'chocolate chip', 'chocolate bar'
          ],
          'lemon': [
            'lemon juice', 'fresh lemon juice', 'lemon zest', 'lemon peel',
            'lemon extract', 'lemon oil', 'juice of lemon'
          ],
          'orange': [
            'orange juice', 'fresh orange juice', 'orange zest', 'orange peel',
            'orange extract', 'orange oil'
          ],
          'pineapple': [
            'fresh pineapple', 'pineapple juice', 'pineapple chunks', 
            'pineapple rings', 'crushed pineapple'
          ],
          'honey': [
            'raw honey', 'pure honey', 'wildflower honey', 'clover honey'
          ],
          'walnut': [
            'walnuts', 'walnut pieces', 'walnut halves', 'chopped walnuts',
            'walnut oil'
          ],
          'corn': [
            'corn kernels', 'sweet corn', 'corn on the cob', 'cornmeal',
            'cornstarch', 'corn flour', 'corn syrup', 'corn oil',
            'popcorn', 'corn chips'
          ],
          'cabbage': [
            'green cabbage', 'red cabbage', 'purple cabbage', 'savoy cabbage',
            'napa cabbage', 'chinese cabbage', 'cabbage leaves'
          ],
          'grapefruit': [
            'fresh grapefruit', 'grapefruit juice', 'grapefruit segments',
            'pink grapefruit', 'white grapefruit'
          ],
          'black tea': [
            'black tea leaves', 'black tea bags', 'earl grey', 'english breakfast tea',
            'assam tea', 'ceylon tea', 'darjeeling tea'
          ]
        };

        // Check for specific variations using exact word matching
        const variations = specificVariations[trigger] || [];
        return variations.some(variation => containsExactWord(ingredientLower, variation));
      });

      // If any direct matches are found, don't check for "may contain"
      if (contains.length > 0) {
        return {
          contains,
          mayContain: []
        };
      }

      // Only check for potential matches if no direct matches were found
      // This should be much more conservative and specific
      const mayContain = triggers.filter(trigger => {
        // Very specific "may contain" matches - only for processed foods that commonly contain these triggers
        const conservativeMayContain = {
          'egg': [
            'mayonnaise', 'pasta', 'noodles', 'bread', 'cake', 'cookie', 'muffin'
          ],
          'milk': [
            'butter', 'cheese', 'cream', 'yogurt', 'chocolate', 'ice cream'
          ],
          'wheat': [
            'flour', 'bread', 'pasta', 'noodles', 'crackers', 'cereal'
          ],
          'soybean': [
            'vegetable oil', 'lecithin'
          ],
          'corn': [
            'high fructose corn syrup', 'corn starch', 'corn syrup'
          ]
          // Note: Removed overly broad categories for black tea, orange, etc. 
          // as they were causing false positives
        };

        const potentialMatches = conservativeMayContain[trigger] || [];
        return potentialMatches.some(match => containsExactWord(ingredientLower, match));
      });

      return {
        contains,
        mayContain
      };
    }

    // Helper function to check if an ingredient contains or may contain trigger foods
    function checkIngredientWarnings(ingredient, selectedTriggerFoods) {
      const cleanedIngredient = cleanText(ingredient);
      const warnings = [];
      const condiments = ["Ketchup", "Mayonnaise", "Mustard"];
      
      // Helper function to check if a word is contained within ingredient text
      const containsWord = (text, word) => {
        const regex = new RegExp(`(^|\\s)${word}($|\\s|[,.:;])`, 'i');
        return regex.test(text);
      };
      
      // First check if the ingredient is a condiment
      const matchedCondiment = condiments.find(c => containsWord(cleanedIngredient, c));
      
      if (matchedCondiment) {
        // Get the relationship data for this condiment
        const condimentRelationship = ingredientRelationships[matchedCondiment];
        
        if (condimentRelationship) {
          // Check if any of the condiment's mayContain ingredients match user's selected trigger foods
          selectedTriggerFoods.forEach(triggerFood => {
            // Check if this trigger food is in the condiment's mayContain list
            const containsTrigger = condimentRelationship.mayContain.some(ingredient => 
              containsWord(ingredient, triggerFood)
            );
            
            if (containsTrigger) {
              warnings.push({
                triggerFood,
                type: 'contains',
                message: `Contains ${triggerFood}`
              });
            }
          });
        }
        return warnings;
      }
      
      // Track which trigger foods we've already added warnings for
      const processedTriggers = new Set();
      
      // Then check for regular trigger foods (excluding condiments)
      selectedTriggerFoods.forEach(triggerFood => {
        // Skip condiments as trigger foods for regular ingredients and already processed triggers
        if (condiments.includes(triggerFood) || processedTriggers.has(triggerFood)) {
          return;
        }

        const relationship = ingredientRelationships[triggerFood];
        if (!relationship) return;

        // Check direct forms using word boundaries
        const containsTrigger = relationship.directForms.some(form => 
          containsWord(cleanedIngredient, form)
        );
        
        if (containsTrigger) {
          warnings.push({
            triggerFood,
            type: 'contains',
            message: `Contains ${triggerFood}`
          });
          processedTriggers.add(triggerFood);
          return;
        }

        // Check "may contain" forms for potential triggers
        if (!processedTriggers.has(triggerFood)) {
          const mayContainTrigger = relationship.mayContain.some(form => 
            containsWord(cleanedIngredient, form)
          );
          
          if (mayContainTrigger) {
            // For chocolate specifically, treat sugar and milk as "contains" rather than "may contain"
            // since chocolate almost always contains sugar and often contains milk
            if (cleanedIngredient.toLowerCase().includes('chocolate')) {
              if (triggerFood === 'Sugar' || triggerFood === 'Milk') {
                warnings.push({
                  triggerFood,
                  type: 'contains',
                  message: `Contains ${triggerFood}`
                });
              } else {
                warnings.push({
                  triggerFood,
                  type: 'mayContain',
                  message: `May contain ${triggerFood} - check label`
                });
              }
            } else {
              warnings.push({
                triggerFood,
                type: 'mayContain',
                message: `May contain ${triggerFood} - check label`
              });
            }
            processedTriggers.add(triggerFood);
          }
        }
      });

      return warnings;
    }

    // Update the checkRecipeForTriggerFoods function to offer pasta substitutions for wheat
    function checkRecipeForTriggerFoods(recipe, selectedTriggerFoods) {
      if (!selectedTriggerFoods || selectedTriggerFoods.length === 0) {
        return {
          containsTriggerFoods: [],
          substitutions: [],
          canBeModified: true
        };
      }

      const substitutions = [];
      const containsTriggerFoods = [];
      const cleanedIngredients = cleanIngredientsList(recipe.ingredients);
      
      cleanedIngredients.forEach(ingredient => {
        const condiments = ["Ketchup", "Mayonnaise", "Mustard"];
        const matchedCondiment = condiments.find(c => 
          new RegExp(`(^|\\s)${c}($|\\s|[,.:;])`, 'i').test(ingredient)
        );
        if (matchedCondiment) {
          const condimentTriggers = ingredientRelationships[matchedCondiment]?.mayContain || [];
          const relevantTriggers = condimentTriggers.filter(ct => 
            selectedTriggerFoods.some(tf => 
              new RegExp(`(^|\\s)${tf}($|\\s|[,.:;])`, 'i').test(ct)
            )
          );
          if (relevantTriggers.length > 0) {
            if (replacementMapping[matchedCondiment]) {
              substitutions.push({
                ingredient,
                triggerFood: matchedCondiment,
                replacements: replacementMapping[matchedCondiment]
              });
            }
          }
          return;
        }

        selectedTriggerFoods.forEach(triggerFood => {
          if (condiments.includes(triggerFood)) {
            return;
          }
          const relationship = ingredientRelationships[triggerFood];
          if (!relationship) return;

          // Check direct forms
          const containsTrigger = relationship.directForms.some(form => 
            new RegExp(`(^|\\s)${form}($|\\s|[,.:;])`, 'i').test(ingredient)
          );
          if (containsTrigger) {
            containsTriggerFoods.push(triggerFood);
            // Get substitutions from replacementMapping
            if (replacementMapping[triggerFood]) {
              const replacements = replacementMapping[triggerFood]
                .filter(r => !r.includes(':') && !r.includes('-'))
                .map(r => r.trim())
                .filter(r => r);
              substitutions.push({
                ingredient,
                triggerFood,
                replacements
              });
            }
          } else if (
            // Special case: pasta and wheat
            triggerFood === 'Wheat' &&
            /pasta|spaghetti|macaroni|linguine|fettuccine|lasagna|ravioli|penne|rigatoni|farfalle|orzo|tortellini|gnocchi|tagliatelle|vermicelli|ziti|manicotti|shells|rotini|angel hair|elbow macaroni/i.test(ingredient)
          ) {
            // Tag as may contain and offer gluten-free pasta as a substitution
            if (!substitutions.some(sub => sub.ingredient === ingredient && sub.triggerFood === 'Wheat')) {
              substitutions.push({
                ingredient,
                triggerFood: 'Wheat',
                replacements: [
                  'Gluten-free pasta',
                  'Chickpea pasta',
                  'Lentil pasta',
                  'Brown rice pasta',
                  'Zucchini noodles (zoodles)',
                  'Spaghetti squash'
                ]
              });
            }
          }
        });
      });
      return {
        containsTriggerFoods: [...new Set(containsTriggerFoods)],
        substitutions,
        canBeModified: substitutions.length > 0
      };
    }

    // Update the recipe display functions to include ingredient warnings and section formatting
    function displayRecipeIngredients(ingredients, selectedTriggerFoods) {
      const cleanedIngredients = cleanIngredientsList(ingredients);
      let html = '';
      let currentSection = '';
      
      cleanedIngredients.forEach(ingredient => {
        // Check if this ingredient is a section header (like "For the crust:", "Sauce:", etc.)
        const sectionHeaderPattern = /^(For the |For |Sauce:|Noodles:|Filling:|Crust:|Dressing:|Marinade:|Glaze:|Topping:|Base:|Garnish:)/i;
        const isEmptyLine = ingredient.trim() === '';
        
        if (isEmptyLine) {
          // Skip empty lines but add some spacing
          html += '<li class="ingredient-spacer"></li>';
          return;
        }
        
        if (sectionHeaderPattern.test(ingredient)) {
          // This is a section header
          currentSection = ingredient;
          html += `<li class="ingredient-section-header">${ingredient}</li>`;
          return;
        }
        
        // Regular ingredient - check for trigger warnings
        const warnings = checkIngredientWarnings(ingredient, selectedTriggerFoods);
        
        // Separate Contains and May Contain warnings
        const containsWarnings = warnings.filter(w => w.type === 'contains');
        const mayContainWarnings = warnings.filter(w => w.type === 'mayContain');
        
        // Prioritize Contains warnings over May Contain
        const warningHTML = containsWarnings.length > 0 
          ? containsWarnings.map(warning => `
              <span class="ingredient-warning ${warning.type}">
                ${warning.message}
              </span>
            `).join('')
          : mayContainWarnings.map(warning => `
              <span class="ingredient-warning ${warning.type}">
                ${warning.message}
              </span>
            `).join('');
        
        html += `
          <li class="ingredient-item ${currentSection ? 'ingredient-under-section' : ''}">
            ${ingredient}
            ${warningHTML}
          </li>
        `;
      });
      
      return html;
    }

    let recipes = []; // Store loaded recipes
    let selectedFoods = [];
    let selectedDietaryPreference = "none";
    const shownMealIds = new Set();

    // Update path to icons - use relative path
    const imagesPath = './icons/';
    
    // Load recipes from embedded data instead of external files
    async function loadRecipes() {
      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'loading';
      loadingMessage.textContent = 'Loading recipes...';
      document.body.appendChild(loadingMessage);

      try {
        console.log('Loading recipes from embedded data...');
        
        // Embedded recipe data - Part 1
        const data1 = {
  "recipes": [
    {
      "id": "1", 
      "name": "Penne with Vodka Sauce and Mini Meatballs",
      "mealType": "dinner",
      "calories": 720,
      "ingredients": [
        "12 ounces penne pasta",
        "8 ounces ground beef chuck",
        "3/4 cup grated parmesan cheese",
        "1/4 cup breadcrumbs",
        "1 large egg",
        "3/4 cup fresh basil",
        "3 cloves garlic",
        "2 1/2 pounds beefsteak tomatoes",
        "2 tablespoons extra-virgin olive oil",
        "1/4 cup vodka",
        "1/4 cup heavy cream",
        "Kosher salt",
        "Black pepper"
      ],
      "instructions": "1. Bring a large pot of salted water to a boil. Add the pasta and cook as the label directs. Reserve 1/2 cup cooking water, then drain.\n2. Mix the beef, 1/4 cup parmesan, breadcrumbs, egg, 1/2 cup basil, minced garlic and 1/2 teaspoon salt until just combined. Form into 3/4-inch meatballs.\n3. Grate the tomatoes into a medium bowl; discard the skins.\n4. Heat olive oil in a large nonstick skillet, add meatballs. Cook until browned, 2-3 minutes.\n5. Add sliced garlic, cook 1 minute. Add vodka, grated tomatoes and cream. Simmer until sauce thickens and meatballs are cooked, 8-10 minutes.\n6. Season with salt and pepper.\n7. Add pasta and remaining basil; toss with reserved cooking water as needed.\n8. Remove from heat, add remaining parmesan and toss.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 26,
        "saturatedFat": 10,
        "cholesterol": 105,
        "sodium": 550,
        "carbs": 79,
        "fiber": 5,
        "protein": 34
      },
      "image": "recipe images/Penne with Vodka Sauce and Mini Meatballs.webp"
    },
    {
      "id": "2",
      "name": "Shredded, Saucy BBQ Chicken Sammies",
      "mealType": "lunch",
      "calories": 357,
      "ingredients": [
        "1 cup chicken stock",
        "1 bottle Mexican beer",
        "24 ounces boneless, skinless chicken breast",
        "2 tablespoons extra-virgin olive oil",
        "2 cloves garlic, chopped",
        "1 medium onion, finely chopped",
        "2 tablespoons Worcestershire sauce",
        "1 tablespoon hot sauce",
        "2 tablespoons grill seasoning blend",
        "3 tablespoons dark brown sugar",
        "4 tablespoons tomato paste",
        "1 large sour deli pickle, chopped",
        "6-8 slices sweet bread and butter pickles, chopped",
        "6 soft burger rolls, split"
      ],
      "instructions": "1. Bring chicken stock and beer to a simmer in a small to medium skillet. Add chicken breast and poach for 10 minutes, turning once halfway through.\n2. Meanwhile, heat another medium skillet over medium-low heat. Add olive oil, garlic, and onion; sauté gently.\n3. In a medium bowl, combine Worcestershire sauce, hot sauce, grill seasoning, brown sugar, and tomato paste.\n4. When chicken is cooked, add 2 ladles of cooking liquid to the sauce mixture and combine.\n5. Remove chicken, slice it, and transfer to the bowl with sauce. Shred using two forks and mix with sauce.\n6. Add shredded chicken mixture to the onions and garlic; combine well. Simmer 5-10 minutes, adding extra cooking liquid for desired sauciness.\n7. Combine sour and sweet pickles in a small bowl.\n8. Split rolls and fill with scoops of shredded chicken. Top with pickle relish and serve.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 8,
        "saturatedFat": 1,
        "cholesterol": 22,
        "sodium": 775,
        "carbs": 50,
        "fiber": 2,
        "sugar": 22,
        "protein": 13
      },
      "image": "recipe images/Shredded, Saucy BBQ Chicken Sammies.jpg"
    },
    {
      "id": "3",
      "name": "Tuscan Chicken Skillet",
      "mealType": "dinner",
      "calories": 1064,
      "ingredients": [
        "12 ounces fettuccine",
        "4 slices bacon, chopped",
        "1 pound chicken tenders",
        "2 cloves garlic, minced",
        "4 plum tomatoes, chopped",
        "1 cup heavy cream",
        "5 ounces baby spinach",
        "3/4 cup grated Parmesan",
        "3 tablespoons fresh basil, chopped",
        "Kosher salt",
        "Black pepper"
      ],
      "instructions": "1. Bring a large pot of salted water to a boil. Cook fettuccine according to package directions; drain.\n2. Put bacon in a large, cold skillet, cook over medium-high heat until crispy, about 8 minutes; transfer to a plate.\n3. Season chicken with salt and pepper, add to skillet in single layer. Cook until golden brown, 2-3 minutes per side, then cook 4 minutes more until done. Transfer to plate with bacon.\n4. Reduce heat to medium, add garlic and cook until fragrant, about 30 seconds.\n5. Add tomatoes and cream, bring to simmer. Add spinach and stir until wilted.\n6. Add bacon, chicken, fettuccine and Parmesan; toss until well coated. Season with salt and pepper.\n7. Sprinkle with basil and serve.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 59,
        "saturatedFat": 25,
        "cholesterol": 152,
        "sodium": 1111,
        "carbs": 88,
        "fiber": 6,
        "sugar": 6,
        "protein": 45
      },
      "image": "recipe images/Tuscan Chicken Skillet.jpg"
    },
    {
      "id": "4",
      "name": "Chicken, Florentine Style",
      "mealType": "dinner",
      "calories": 789,
      "ingredients": [
        "4 boneless skinless chicken breasts",
        "All-purpose flour, for dredging",
        "6 tablespoons unsalted butter",
        "2 tablespoons shallots, sliced",
        "1 tablespoon chopped garlic",
        "1 1/2 cups dry white wine",
        "1 cup whipping cream",
        "1 tablespoon fresh Italian parsley, chopped",
        "20 ounces frozen cut-leaf spinach, thawed and drained",
        "Salt",
        "Black pepper"
      ],
      "instructions": "1. Season chicken with salt and pepper. Dredge in flour, shaking off excess.\n2. Melt 2 tablespoons butter in large skillet over medium heat. Cook chicken until brown, about 5 minutes per side. Transfer to plate and tent with foil.\n3. In same skillet, melt 2 tablespoons butter. Add shallots and garlic, sauté until shallots are translucent, about 1 minute, scraping up browned bits.\n4. Add wine, increase heat to medium-high and boil until reduced by half, about 3 minutes.\n5. Add cream and boil until sauce reduces by half, stirring often, about 3 minutes. Stir in parsley and season with salt and pepper.\n6. Add chicken and accumulated juices to sauce, turning to coat.\n7. In another skillet, melt remaining butter. Add spinach and sauté until heated through. Season with salt and pepper.\n8. Arrange spinach on platter, place chicken on top, and pour sauce over. Serve.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 44,
        "saturatedFat": 24,
        "cholesterol": 311,
        "sodium": 1391,
        "carbs": 16,
        "fiber": 4,
        "sugar": 4,
        "protein": 68
      },
      "image": "recipe images/Chicken, Florentine Style.jpg"
    },
    {
      "id": "5",
      "name": "Sheet Pan Chicken Shawarma",
      "mealType": "lunch",
      "calories": 503,
      "ingredients": [
        "2 tablespoons olive oil",
        "1 teaspoon ground cumin",
        "1/2 teaspoon ground cinnamon",
        "1/4 teaspoon ground allspice",
        "1/4 teaspoon ground cardamom",
        "1/4 teaspoon ground turmeric",
        "2 cloves garlic, grated",
        "1 pound boneless, skinless chicken thighs",
        "1 medium onion",
        "1/2 cup full-fat Greek yogurt",
        "1/2 lemon, juiced",
        "4 pieces pita bread",
        "3 dill pickle spears, chopped",
        "1 Roma tomato, chopped",
        "1 cup shredded lettuce",
        "Kosher salt",
        "Black pepper"
      ],
      "instructions": "1. Preheat oven to 450 degrees F.\n2. In a large bowl, combine olive oil, cumin, cinnamon, allspice, cardamom, turmeric, garlic, 2 teaspoons salt and pepper.\n3. Add chicken (sliced into 1-inch pieces) and onions (sliced into 1-inch half-moons); toss to coat evenly.\n4. Spread in single layer on sheet pan, ensuring pieces don't overlap.\n5. Bake until chicken is cooked through and onions are slightly caramelized, about 15 minutes.\n6. Meanwhile, mix yogurt, lemon juice and pepper in a medium bowl until smooth.\n7. Warm pitas in microwave, 30 seconds to 1 minute.\n8. Assemble: spread yogurt sauce on pitas, top with chicken and onions, then add pickles, tomatoes and lettuce.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 25,
        "saturatedFat": 7,
        "cholesterol": 115,
        "sodium": 1363,
        "carbs": 42,
        "fiber": 3,
        "sugar": 5,
        "protein": 27
      },
      "image": "recipe images/Sheet Pan Chicken Shawarma.jpg"
    }
  ]
};

        // Embedded recipe data - Part 2
        const data2 = {
  "recipes": [
    {
      "id": "101",
      "name": "Chicken and Broccoli with White Sauce",
      "mealType": "dinner",
      "calories": 462,
      "ingredients": [
        "1 1/2 pounds (about 2) boneless, skinless chicken breast",
        "Kosher salt",
        "1/4 teaspoon ground white pepper",
        "5 tablespoons cornstarch",
        "6 tablespoons plus 1 teaspoon neutral oil, such as vegetable oil, divided",
        "4 cups (about 1 pound) broccoli florets",
        "1/2 tablespoon grated garlic (from about 3 cloves)",
        "1/2 teaspoon grated ginger",
        "1 1/2 cups chicken broth",
        "1 teaspoon chicken bouillon powder, such as Lee Kum Kee brand",
        "1/2 teaspoon sugar",
        "Hot steamed rice, for serving"
      ],
      "instructions": "1. Cut the chicken breasts in half lengthwise, then cut them again at a slight angle into 1/4-inch-thick slices. Transfer to a medium bowl. Add 1 1/2 teaspoons kosher salt, 1/4 teaspoon ground white pepper and 3 tablespoons cold water. Use your hands (wear gloves if you like) to massage the seasonings into the chicken until most is absorbed, about 1 minute. Add 3 tablespoons cornstarch and mix until the cornstarch is moistened. Add 3 tablespoons neutral oil and massage until combined. Set the chicken aside to marinate at room temperature for 30 minutes.\n2. Bring 4 cups water to a boil in a wok over high heat and add 2 teaspoons salt and 1 teaspoon neutral oil. Add the broccoli and boil until it turns bright green, about 2 minutes. Drain the broccoli and rinse under cold water until the broccoli is cool enough to handle. Drain and set aside.\n3. Stir the remaining 2 tablespoons cornstarch and 3 tablespoons cold water together in a small bowl until combined. Set aside.\n4. Heat a wok over high heat until you see the first few wisps of smoke, about 3 minutes. Remove the wok from the heat and add the remaining 3 tablespoons vegetable oil and swirl to coat the wok. Return to high heat and add the marinated chicken. Spread it out evenly so every chicken piece has contact with the wok. Let sit until it starts to brown, about 2 minutes. Toss the chicken with a wok turner or spatula and cook until just slightly pink, about 2 minutes.\n5. Add the grated garlic and ginger to the wok and stir until fragrant, about 30 seconds. Add the broccoli and stir-fry 30 seconds. Add the chicken broth, bouillon powder and sugar and bring to a boil. Taste and adjust the seasoning if needed.\n6. Slowly drizzle the cornstarch slurry into the wok and continue to cook until the sauce thickens and coats the broccoli. Pour the mixture over hot steamed rice and serve immediately.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 26,
        "saturatedFat": 4,
        "cholesterol": 124,
        "sodium": 831,
        "carbs": 14,
        "fiber": 0,
        "sugar": 0,
        "protein": 42
      }
    },
    {
      "id": "102",
      "name": "Sweet & Sour Couscous-Stuffed Peppers",
      "mealType": "dinner",
      "calories": 379,
      "ingredients": [
        "2 medium carrots, cut into chunks",
        "2 stalks celery, cut into chunks",
        "1 large shallot, cut into chunks",
        "1 1/2 tablespoons olive oil",
        "1/2 pound lean ground beef",
        "2 tablespoons plus 4 teaspoons tomato paste",
        "1/3 cup chopped fresh parsley, dill or a combination",
        "1/3 cup golden raisins",
        "2 tablespoons red wine vinegar",
        "Kosher salt",
        "4 bell peppers (any color), halved lengthwise and seeded",
        "1/2 cup whole wheat couscous",
        "3/4 cup grated asiago cheese"
      ],
      "instructions": "1. Preheat the oven to 450 degrees F. Pulse the carrots, celery and shallots in a food processor until coarsely chopped.\n2. Heat 1 tablespoon of the olive oil in a large nonstick skillet over medium high. Add the chopped vegetables and cook, stirring frequently, until light golden and soft, 8 to 10 minutes. (Add a splash of water if the mixture begins to stick.) Add the ground beef and 4 teaspoons of the tomato paste and cook, breaking the mixture up with a wooden spoon, until browned, about 4 minutes. Add 1/2 cup water, the parsley, raisins, 1 tablespoon of the vinegar and 3/4 teaspoon salt. Bring to a simmer and cook until most of the water is absorbed and the mixture gets saucy, about 1 minute. Let cool slightly.\n3. Meanwhile, toss the pepper halves with the remaining 1/2 tablespoon oil in a microwave-safe bowl. Cover with plastic wrap and microwave until the peppers are pliable, 10 to 12 minutes. Carefully uncover the bowl and pour out any liquid that has accumulated.\n4. Stir the couscous into the beef mixture. Whisk together the remaining 2 tablespoons tomato paste, 1 tablespoon vinegar and 3/4 cup water in the bottom of a large baking dish.\n5. Carefully transfer the peppers to the baking dish cut-side up and fill each pepper with the couscous mixture. Sprinkle with the cheese. Cover with foil and bake until the peppers are tender and the stuffing is hot, 20 to 25 minutes. Serve warm or at room temperature drizzled with the tomato cooking liquid.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 15,
        "saturatedFat": 5,
        "cholesterol": 49,
        "sodium": 685,
        "carbs": 43,
        "fiber": 8,
        "sugar": 15,
        "protein": 22
      }
    },
    {
      "id": "103",
      "name": "Herb-Ricotta Dumplings with Tomatoes and Peppers",
      "mealType": "dinner",
      "calories": 500,
      "ingredients": [
        "1/4 cup extra-virgin olive oil, plus more for serving",
        "5 sprigs fresh thyme",
        "1 red or orange bell pepper, sliced",
        "1/2 yellow onion, thinly sliced",
        "Kosher salt and freshly ground black pepper",
        "2 cloves garlic, thinly sliced",
        "20 ounces cherry tomatoes",
        "1/4 cup dry white wine",
        "16 ounces whole-milk ricotta",
        "1 cup all-purpose flour",
        "1/2 cup chopped fresh basil",
        "1/3 cup chopped fresh chives",
        "1 large egg",
        "Semolina flour, for dusting",
        "Grated Pecorino Romano, for topping"
      ],
      "instructions": "For the tomato and pepper sauce: Heat the oil in a medium saucepan over medium heat. Add the thyme and cook until fragrant, about 1 minute. Add the bell pepper, onion and 1/2 teaspoon salt and cook until the vegetables are softened and the onion is translucent, about 5 minutes. Add the garlic and cook for 1 minute. Add the tomatoes and 1/2 teaspoon salt and cook until the tomatoes are softened and beginning to burst, about 5 minutes. Add the white wine and 1/4 cup water and bring to a boil. Reduce the heat and simmer until the sauce has thickened slightly, about 10 minutes. Remove and discard the thyme sprigs. Taste and adjust the seasoning with salt and pepper.\nFor the herb-ricotta dumplings: Bring a medium saucepan of salted water to a boil. Put the ricotta in a medium bowl, add the flour, basil, chives, egg, 1 teaspoon salt and a few grinds of pepper and gently combine until it just forms a sticky dough. Generously flour a work surface with semolina flour. Place the dough on the semolina and sprinkle the top with a light dusting of more semolina. Press out the dough into a rectangle about 8 inches by 6 inches and 1/2 inch thick. Cut into 1-inch squares.\nTransfer the dumplings to the boiling water with a slotted spoon and cook until tender and floating, about 5 minutes. Transfer the dumplings with the same spoon to the sauce; let sit for 2 minutes (resting will help the dumplings keep their shape). Gently toss with the sauce. Divide into bowls and top with grated Pecorino Romano and a drizzle of olive oil.",
      "isVegetarian": true,
      "isVegan": false,
      "macros": {
        "fat": 31,
        "saturatedFat": 12,
        "cholesterol": 104,
        "sodium": 743,
        "carbs": 37,
        "fiber": 4,
        "sugar": 6,
        "protein": 20
      }
    },
    {
      "id": "104",
      "name": "Healthy Mediterranean Baked Haddock",
      "mealType": "dinner",
      "calories": 366,
      "ingredients": [
        "Two 14-ounce cans cherry tomatoes",
        "1/2 cup dry white wine",
        "1/2 cup pitted Kalamata olives, sliced in half",
        "4 cloves garlic, minced",
        "2 tablespoons capers, drained",
        "1 tablespoon honey",
        "Kosher salt and freshly ground black pepper",
        "Four 6-ounce haddock fillets, skin removed",
        "1/2 teaspoon Italian seasoning",
        "1/2 teaspoon sweet paprika",
        "2 tablespoons olive oil",
        "4 slices crusty bread"
      ],
      "instructions": "1. Preheat the oven to 425 degrees F. Combine the cherry tomatoes, white wine, olives, 3 of the garlic cloves, capers, honey, 1/2 teaspoon salt and a few grinds of pepper in a 9-by-13-inch baking dish.\n2. Pat the haddock fillets dry with a paper towel and season the flesh side with the Italian seasoning, paprika, 1 teaspoon salt and a few grinds of pepper. Nestle the fillets into the sauce in the baking dish. Bake until the sauce is bubbling around the edges and the fillets are cooked through and easily flaked with a fork, 15 to 20 minutes.\n3. Meanwhile, mix the remaining 1 garlic clove with the olive oil, 1/4 teaspoon salt and a few grinds of pepper in a small bowl. Brush both sides of each slice of bread with the oil mixture and place onto a baking sheet. Bake until the bread is toasted, 5 to 7 minutes.\n4. Serve the fish on plates with the sauce and bread on the side.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 11,
        "saturatedFat": 2,
        "cholesterol": 92,
        "sodium": 1081,
        "carbs": 29,
        "fiber": 6,
        "sugar": 11,
        "protein": 33
      }
    },
    {
      "id": "105",
      "name": "Sheet Pan Kofta and Tomatoes",
      "mealType": "dinner",
      "calories": 364,
      "ingredients": [
        "Nonstick cooking spray, for the foil",
        "2 large yellow onions",
        "1 pound ground lamb or beef",
        "1 teaspoon turmeric",
        "1 teaspoon sumac",
        "Kosher salt and freshly ground black pepper",
        "1 cup fresh cilantro, chopped",
        "4 Roma tomatoes"
      ],
      "instructions": "1. Preheat the oven to 400 degrees F. Line a baking sheet with aluminum foil and coat with cooking spray.\n2. Grate 1 of the onions into a large bowl. Add the ground meat, turmeric, sumac, 1 teaspoon salt and 1/2 teaspoon pepper. Mix well using your hands or a spoon. Add the cilantro and mix again to combine.\n3. Wet your hands with some water (to avoid the mixture sticking to your hands), divide the mixture into 8 pieces and form each one into an oval patty. Place the patties on the prepared baking sheet.\n4. Cut the tomatoes into quarters and cut the remaining onion into large chunks. Place both on the baking sheet between the koftas. Season with salt and pepper. Bake until the koftas are fully cooked and the vegetables have softened, about 20 minutes. Turn the oven to broil and broil until the vegetables are slightly charred in spots and the kofta are browned, 2 to 3 minutes.\n\nCook's Note: You can also use a food processor or a stand mixer to mix the kofta ingredients.",
      "isVegetarian": false,
      "isVegan": false,
      "macros": {
        "fat": 27,
        "saturatedFat": 12,
        "cholesterol": 83,
        "sodium": 663,
        "carbs": 11,
        "fiber": 2,
        "sugar": 5,
        "protein": 20
      }
    }
  ]
};
        
        const loadedRecipes = [...(data1.recipes || []), ...(data2.recipes || [])];
        console.log(`Successfully loaded ${loadedRecipes.length} recipes from embedded data`);
        console.log('Sample recipe:', loadedRecipes[0]); // Log first recipe to verify structure
        
        if (loadedRecipes.length === 0) {
          showNotification('No recipes found in the embedded data.', 'error');
        } else {
          showNotification(`Successfully loaded ${loadedRecipes.length} recipes!`, 'success');
        }
        
        return loadedRecipes;
      } catch (error) {
        console.error('Error loading embedded recipes:', error);
        showNotification('Failed to load recipes. Please refresh the page and try again.', 'error');
        return [];
      } finally {
        loadingMessage.remove();
      }
    }

    // Check if user is already verified
    document.addEventListener('DOMContentLoaded', async function() {
      const verifyBtn = document.getElementById('verifyBtn');
      const inputs = document.querySelectorAll('.input-fields input');
      const verificationMessage = document.getElementById('verificationMessage');
      const verificationOverlay = document.getElementById('verificationOverlay');
      const mainContent = document.getElementById('mainContent');

      // Load recipes immediately when the page loads
      try {
        console.log('Loading recipes on page load...');
        recipes = await loadRecipes();
        if (recipes.length > 0) {
          console.log(`Successfully loaded ${recipes.length} recipes`);
        } else {
          console.error('No recipes were loaded');
        }
      } catch (error) {
        console.error('Error loading recipes:', error);
      }

      // Focus first input
      inputs[0].focus();

      // Handle input changes
      inputs.forEach((input, index) => {
        input.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
          if (this.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        });
      });
      
      verifyBtn.onclick = async function() {
        const code = Array.from(inputs).map(input => input.value).join('');

        const response = await fetch("/api/verify", {
          method: "POST",
          body: JSON.stringify({
            verification_code: code,
          })
        });
        const result = await response.json();
        
        if (result.success === true) {
          // Show success message
          verificationMessage.textContent = 'Verification successful!';
          verificationMessage.style.color = '#00ff00';
          verificationMessage.style.display = 'block';
          
          // Show main content
          mainContent.style.display = 'block';
          mainContent.classList.remove('main-content-hidden');
          
          // Initialize components
          initFoodSelection();
          initDietaryPreferences();
          
          // Hide overlay
          verificationOverlay.style.opacity = '0';
          setTimeout(() => {
            verificationOverlay.style.display = 'none';
          }, 800);

          // Ensure recipes are loaded
          if (recipes.length === 0) {
            try {
              recipes = await loadRecipes();
            } catch (error) {
              console.error('Error loading recipes after verification:', error);
              showNotification('Failed to load recipes. Please refresh the page.', 'error');
            }
          }
        } else {
          const message = code.length !== 7 ? 'Please enter a 7-character code' : 'Verification failed'
          verificationMessage.textContent = message;
          verificationMessage.style.color = '#ff3333';
          verificationMessage.style.display = 'block';
        }
      };

      // Initialize the Find Replacement Meals button
      const fetchButton = document.getElementById('fetchRecipesBtn');
      if (fetchButton) {
        console.log('Initializing Find Replacement Meals button');
        fetchButton.addEventListener('click', async function() {
          console.log('Find Replacement Meals button clicked');
          const spinner = this.querySelector('.loading-spinner');
          spinner.style.display = 'inline-block';
          
          try {
            // If recipes haven't been loaded yet, try loading them again
            if (recipes.length === 0) {
              recipes = await loadRecipes();
            }
            await fetchAndDisplayRecipes();
          } catch (error) {
            console.error('Error fetching recipes:', error);
            showNotification('Failed to fetch recipes. Please try again later.', 'error');
          } finally {
            spinner.style.display = 'none';
          }
        });
      } else {
        console.error('Find Replacement Meals button not found');
      }
    });

    // Add placeholder image as base64 data URL
    const placeholderImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNFNUU1RTUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY2NjY2NiIgZm9udC1zaXplPSIxNnB4Ij5JbWFnZSBub3QgYXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';

    function initFoodSelection() {
      const foodSelectionDiv = document.getElementById('foodSelection');
      if (!foodSelectionDiv) {
        console.error('Food selection div not found');
        return;
      }
      
      foodSelectionDiv.innerHTML = '';
      
      triggerFoods.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'food-item';
        
        const img = document.createElement('img');
        img.src = `${imagesPath}${food.replace(/ /g, '%20')}.png`;
        img.alt = food;
        img.onerror = function() {
          this.src = placeholderImage;
          console.error(`Failed to load image for ${food}`);
        };
        
        const button = document.createElement('button');
        button.className = 'food-toggle-btn';
        button.textContent = food;
        
        foodItem.appendChild(img);
        foodItem.appendChild(button);
        
        foodItem.addEventListener('click', function() {
          this.classList.toggle('selected');
          const index = selectedFoods.indexOf(food);
          if (index === -1) {
            selectedFoods.push(food);
          } else {
            selectedFoods.splice(index, 1);
          }
          // Update replacement suggestions immediately
          updateReplacementSuggestions();
        });
        
        foodSelectionDiv.appendChild(foodItem);
      });
    }

    function initDietaryPreferences() {
      const dietaryPreferences = document.getElementById('dietaryPreferences');
      if (!dietaryPreferences) {
        console.error('Dietary preferences section not found');
        return;
      }
      
      // Initialize dietary preference options
      const dietOptions = dietaryPreferences.querySelectorAll('input[name="diet-preference"]');
      dietOptions.forEach(radio => {
        radio.addEventListener('change', function() {
          // Remove selected class from all options
          document.querySelectorAll('input[name="diet-preference"]').forEach(opt => 
            opt.closest('.preference-option').classList.remove('selected')
          );
          // Add selected class to the clicked option
          if (this.checked) {
            this.closest('.preference-option').classList.add('selected');
            selectedDietaryPreference = this.value;
          }
        });
      });

      // Initialize meal type options (commented out since meal type section was removed)
      /*
      const mealTypeOptions = dietaryPreferences.querySelectorAll('input[name="meal-type"]');
      mealTypeOptions.forEach(radio => {
        radio.addEventListener('change', function() {
          // Remove selected class from all options
          document.querySelectorAll('input[name="meal-type"]').forEach(opt => 
            opt.closest('.preference-option').classList.remove('selected')
          );
          // Add selected class to the clicked option
          if (this.checked) {
            this.closest('.preference-option').classList.add('selected');
          }
        });
      });
      */
    }

    // Helper function to get unique random meals
    function getUniqueRandomMeals(recipes, count) {
      // Safety check for empty recipes array
      if (!recipes || recipes.length === 0) {
        console.log('No recipes available for selection');
        return [];
      }

      // If we've shown all meals, reset the tracking
      if (shownMealIds.size >= recipes.length) {
        console.log('All meals have been shown, resetting cycle');
        shownMealIds.clear();
      }
      
      // Get meals that haven't been shown in this cycle
      const availableRecipes = recipes.filter(recipe => !shownMealIds.has(recipe.id));
      console.log('Available recipes for random selection:', availableRecipes);
      
      // If no recipes are available after filtering, reset and try one more time
      if (availableRecipes.length === 0) {
        shownMealIds.clear();
        const retryRecipes = recipes.filter(recipe => !shownMealIds.has(recipe.id));
        if (retryRecipes.length === 0) {
          console.log('No recipes available even after reset');
          return [];
        }
        return getUniqueRandomMeals(retryRecipes, count);
      }
      
      const selectedRecipes = [];
      const numToSelect = Math.min(count, availableRecipes.length);
      
      // Select random recipes
      for (let i = 0; i < numToSelect; i++) {
        const randomIndex = Math.floor(Math.random() * availableRecipes.length);
        const selectedRecipe = availableRecipes[randomIndex];
        selectedRecipes.push(selectedRecipe);
        shownMealIds.add(selectedRecipe.id);
        availableRecipes.splice(randomIndex, 1);
      }
      
      return selectedRecipes;
    }

    // Add function to check recipe ingredients against trigger foods and suggest substitutions
    function checkRecipeForTriggerFoods(recipe, selectedTriggerFoods) {
      // If no trigger foods are selected, return that the recipe can be included
      if (!selectedTriggerFoods || selectedTriggerFoods.length === 0) {
        return {
          containsTriggerFoods: [],
          substitutions: [],
          canBeModified: true
        };
      }

      const substitutions = [];
      const containsTriggerFoods = [];
      
      recipe.ingredients.forEach(ingredient => {
        // First check if ingredient is a condiment
        const condiments = ["Ketchup", "Mayonnaise", "Mustard"];
        const matchedCondiment = condiments.find(c => 
          new RegExp(`(^|\\s)${c}($|\\s|[,.:;])`, 'i').test(ingredient)
        );

        if (matchedCondiment) {
          // Get potential trigger ingredients for this condiment
          const condimentTriggers = ingredientRelationships[matchedCondiment]?.mayContain || [];
          
          // Check if any of the condiment's potential triggers match user's selected trigger foods
          const relevantTriggers = condimentTriggers.filter(ct => 
            selectedTriggerFoods.some(tf => 
              new RegExp(`(^|\\s)${tf}($|\\s|[,.:;])`, 'i').test(ct)
            )
          );
          
          if (relevantTriggers.length > 0) {
            // Only add substitution if the condiment contains selected trigger foods
            if (replacementMapping[matchedCondiment]) {
              substitutions.push({
                ingredient,
                triggerFood: matchedCondiment,
                replacements: replacementMapping[matchedCondiment]
              });
            }
          }
          return;
        }

        // Then check for regular trigger foods
        selectedTriggerFoods.forEach(triggerFood => {
          // Skip condiments when checking ingredients
          if (condiments.includes(triggerFood)) {
            return;
          }

          const relationship = ingredientRelationships[triggerFood];
          if (!relationship) return;

          // Check direct forms using word boundaries
          const containsTrigger = relationship.directForms.some(form => 
            new RegExp(`(^|\\s)${form}($|\\s|[,.:;])`, 'i').test(ingredient)
          );
          
          if (containsTrigger) {
            containsTriggerFoods.push(triggerFood);
            // Get substitutions from replacementMapping
            if (replacementMapping[triggerFood]) {
              const replacements = replacementMapping[triggerFood]
                .filter(r => !r.includes(':') && !r.includes('-'))
                .map(r => r.trim())
                .filter(r => r);
              
              substitutions.push({
                ingredient,
                triggerFood,
                replacements
              });
            }
          }
        });
      });
      
      return {
        containsTriggerFoods: [...new Set(containsTriggerFoods)],
        substitutions,
        canBeModified: substitutions.length > 0
      };
    }

    // Update the displayRecipes function to handle trigger foods
    function displayRecipes() {
      console.log('Starting displayRecipes function');
      console.log('Current recipes array:', recipes);
      console.log('Selected dietary preference:', selectedDietaryPreference);
      console.log('Selected foods:', selectedFoods);
      
      const replacementMealSection = document.getElementById('replacementMeal');
      replacementMealSection.innerHTML = '';

      if (recipes.length === 0) {
        console.log('No recipes available');
        replacementMealSection.innerHTML = `
          <div class="meal-card show">
            <p>No recipes loaded. Please try refreshing the page.</p>
          </div>
        `;
        return;
      }

      // Get selected meal type from radio buttons
      const mealTypeRadio = document.querySelector('input[name="meal-type"]:checked');
      const selectedMealType = mealTypeRadio ? mealTypeRadio.value.toLowerCase() : 'any';
      console.log('Selected meal type:', selectedMealType);

      // Filter recipes based on dietary preferences, meal type, and trigger foods
      let filteredRecipes = recipes.filter(recipe => {
        console.log('Checking recipe:', recipe.name);
        console.log('Recipe meal type:', recipe.mealType);
        
        // Check dietary preferences only if specifically selected
        if (selectedDietaryPreference === 'vegetarian' && !recipe.isVegetarian) {
          console.log('Recipe filtered out - not vegetarian');
          return false;
        }
        if (selectedDietaryPreference === 'vegan' && !recipe.isVegan) {
          console.log('Recipe filtered out - not vegan');
          return false;
        }

        // Check meal type - include if 'any' or matches selected type
        // Also include recipes with mealType 'any' for any selected meal type
        if (selectedMealType !== 'any') {
          const recipeMealType = (recipe.mealType || '').toLowerCase();
          if (recipeMealType !== 'any' && recipeMealType !== selectedMealType) {
            console.log('Recipe filtered out - meal type mismatch');
            console.log('Expected:', selectedMealType, 'Got:', recipeMealType);
            return false;
          }
        }

        // Check for trigger foods - EXCLUDE any recipe that contains trigger foods
        if (selectedFoods.length > 0) {
          const triggerCheck = checkRecipeForTriggerFoods(recipe, selectedFoods);
          console.log('Trigger check result:', triggerCheck);
          
          // Only include recipe if it has NO trigger foods
          const shouldInclude = triggerCheck.containsTriggerFoods.length === 0;
          console.log('Recipe included based on triggers:', shouldInclude);
          return shouldInclude;
        }

        // If no trigger foods selected, include the recipe
        return true;
      });

      console.log('Filtered recipes:', filteredRecipes);

      // Get exactly 3 random recipes
      const selectedRecipes = getUniqueRandomMeals(filteredRecipes, 3);
      console.log('Selected recipes:', selectedRecipes);

      if (selectedRecipes.length === 0) {
        console.log('No suitable recipes found after filtering');
        replacementMealSection.innerHTML = `
          <div class="meal-card show">
            <p>No meals found that exclude all selected trigger foods. Please try different selections.</p>
          </div>
        `;
        return;
      }

      // Create and append exactly 3 recipe cards
      const recipeCards = selectedRecipes.slice(0, 3).map(recipe => {
        const card = createRecipeCard(recipe);
        card.classList.add('show');
        return card;
      });

      replacementMealSection.append(...recipeCards);
    }

    // Add function to show replacement details in modal
    function showReplacementDetails(food, replacements) {
      const modal = document.createElement('div');
      modal.className = 'replacement-modal';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'replacement-modal-content';
      
      modalContent.innerHTML = `
        <h2>${food} Replacements</h2>
        <div class="recipe-details">
          <ul>
            ${replacements.map(replacement => `<li>${replacement}</li>`).join('')}
          </ul>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="close-modal-btn">Close</button>
      `;
      
      modal.appendChild(modalContent);
      // Add click event listener to modal background
      modal.addEventListener('click', handleModalBackgroundClick);
      document.body.appendChild(modal);
      
      // Add animation
      requestAnimationFrame(() => {
        modalContent.classList.add('show');
      });
    }

    // Update showReplacementDetails function
    function showReplacementDetails(food, replacements) {
      const modal = document.createElement('div');
      modal.className = 'replacement-modal';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'replacement-modal-content';
      
      modalContent.innerHTML = `
        <h2>${food} Replacements</h2>
        <div class="recipe-details">
          <ul>
            ${replacements.map(replacement => `<li>${replacement}</li>`).join('')}
          </ul>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="close-modal-btn">Close</button>
      `;
      
      modal.appendChild(modalContent);
      // Add click event listener to modal background
      modal.addEventListener('click', handleModalBackgroundClick);
      document.body.appendChild(modal);
      
      // Add animation
      requestAnimationFrame(() => {
        modalContent.classList.add('show');
      });
    }

    // Function to update replacement suggestions
    function updateReplacementSuggestions() {
      const replacementDisplay = document.getElementById('replacementDisplay');
      if (!replacementDisplay) {
        console.error('Replacement display element not found');
        return;
      }
      
      replacementDisplay.innerHTML = '';
      
      // Show replacement suggestions for selected trigger foods
      if (selectedFoods.length === 0) {
        replacementDisplay.innerHTML = '<p>Select trigger foods to see replacement suggestions.</p>';
        return;
      }

      selectedFoods.forEach((food, index) => {
        const replacements = replacementMapping[food];
        if (replacements) {
          const card = document.createElement('div');
          card.className = 'replacement-card';
          
          card.innerHTML = `
            <h3>${food} Replacements:</h3>
            <div class="recipe-details">
              <ul>
                ${replacements.slice(0, 3).map(replacement => `<li>${replacement}</li>`).join('')}
              </ul>
              <button class="view-details-btn" onclick="showReplacementDetails('${food}', ${JSON.stringify(replacements).replace(/"/g, '&quot;')})">
                View All Replacements
              </button>
            </div>
          `;
          
          setTimeout(() => {
            replacementDisplay.appendChild(card);
            requestAnimationFrame(() => {
              card.classList.add('show');
            });
          }, index * 100);
        }
      });
    }

    // Update fetchAndDisplayRecipes to not handle replacement suggestions
    async function fetchAndDisplayRecipes() {
      console.log('Starting fetchAndDisplayRecipes function');
      const spinner = document.querySelector('.loading-spinner');
      spinner.style.display = 'inline-block';
      
      try {
        // Load recipes if not already loaded
        if (recipes.length === 0) {
          console.log('No recipes loaded, attempting to load recipes...');
          recipes = await loadRecipes();
          if (!recipes || recipes.length === 0) {
            throw new Error('No recipes were loaded successfully');
          }
          console.log(`Successfully loaded ${recipes.length} recipes`);
        }
        
        // Display recipes
        console.log('Calling displayRecipes function');
        await displayRecipes();
        
        showNotification('Successfully found replacement meals!', 'success');
      } catch (error) {
        console.error('Error in fetchAndDisplayRecipes:', error);
        showNotification(`Failed to display suggestions: ${error.message}. Please try again.`, 'error');
      } finally {
        spinner.style.display = 'none';
      }
    }

    // Show detailed recipe information
    function showRecipeDetails(recipeId) {
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) return;

      const modal = document.createElement('div');
      modal.className = 'recipe-modal';
      
      const safeRecipeName = getRecipeImagePath(recipe.name);
      const imgElement = document.createElement('img');
      imgElement.className = 'recipe-modal-image';
      imgElement.alt = recipe.name;
      imgElement.src = `./recipe images/${safeRecipeName}.jpg`;
      imgElement.onerror = function() {
        this.onerror = null;
        if(this.src.endsWith('.jpg')) {
          this.src = `./recipe images/${safeRecipeName}.jpeg`;
        } else if(this.src.endsWith('.jpeg')) {
          this.src = `./recipe images/${safeRecipeName}.png`;
        } else {
          this.src = './recipe images/placeholder-meal.jpg';
        }
      };
      
      // Check for trigger foods and get substitutions
      const triggerCheck = checkRecipeForTriggerFoods(recipe, selectedFoods);
      
      // Create substitution suggestions HTML if needed
      let substitutionsHtml = '';
      if (triggerCheck.substitutions.length > 0) {
        // Separate visible trigger foods from hidden condiment trigger foods
        const visibleSubstitutions = triggerCheck.substitutions.filter(sub => 
          !hiddenTriggerFoods.includes(sub.triggerFood)
        );
        const condimentSubstitutions = triggerCheck.substitutions.filter(sub => 
          hiddenTriggerFoods.includes(sub.triggerFood)
        );

        // Create HTML for visible trigger food substitutions
        if (visibleSubstitutions.length > 0) {
          substitutionsHtml += `
            <div class="substitutions-section">
              <h4>Suggested Substitutions:</h4>
              <ul>
                ${visibleSubstitutions.map(sub => `
                  <li>
                    Replace "${sub.ingredient}" with one of:
                    <ul>
                      ${sub.replacements.slice(0, 3).map(r => `<li>${r}</li>`).join('')}
                    </ul>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }

        // Create HTML for condiment substitutions
        if (condimentSubstitutions.length > 0) {
          substitutionsHtml += `
            <div class="substitutions-section">
              <h4>Condiment Substitutions:</h4>
              <ul>
                ${condimentSubstitutions.map(sub => `
                  <li>
                    Replace "${sub.ingredient}" with "${sub.replacements[0]}"
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }
      }
      
      // Extract Cook's Notes and clean instructions for modal
      const { cleanInstructions, cooksNotes } = extractCooksNotes(recipe.instructions);
      
      // Format Cook's Notes for modal
      let modalCooksNotesHtml = '';
      if (cooksNotes.length > 0) {
        modalCooksNotesHtml = `
          <div class="cooks-notes-section">
            <h3>Cook's Note${cooksNotes.length > 1 ? 's' : ''}:</h3>
            <ul>
              ${cooksNotes.map(note => `<li>${note}</li>`).join('')}
            </ul>
          </div>
        `;
      }

      modal.innerHTML = `
        <div class="recipe-modal-content">
          <h2>${recipe.name}</h2>
          <div class="recipe-modal-body">
            <div class="recipe-info">
              <p><strong>Calories:</strong> ${recipe.calories}</p>
              ${recipe.macros ? `
                <div class="macro-info">
                  <p><strong>Protein:</strong> ${recipe.macros.protein}g</p>
                  <p><strong>Carbs:</strong> ${recipe.macros.carbs}g</p>
                  <p><strong>Fat:</strong> ${recipe.macros.fat}g</p>
                </div>
              ` : ''}
            </div>
            ${triggerCheck.containsTriggerFoods.length > 0 ? `
              <div class="trigger-warning">
                <p><strong>Note:</strong> This recipe contains the following trigger foods that need substitution: ${triggerCheck.containsTriggerFoods.join(', ')}.</p>
              </div>
            ` : ''}
            ${substitutionsHtml}
            <h3>Ingredients:</h3>
            <ul>
              ${displayRecipeIngredients(recipe.ingredients, [...selectedFoods, ...hiddenTriggerFoods])}
            </ul>
            <h3>Instructions:</h3>
            <div class="instructions">
              <ol>
                ${cleanInstructionsForHTML(cleanInstructions)
                  .map(step => `<li>${step}</li>`)
                  .join('')}
              </ol>
            </div>
            ${modalCooksNotesHtml}
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="close-modal-btn">Close</button>
        </div>
      `;

      // Insert the image after the title
      modal.querySelector('.recipe-modal-content').insertBefore(imgElement, modal.querySelector('.recipe-modal-body'));
      // Add click event listener to modal background
      modal.addEventListener('click', handleModalBackgroundClick);
      document.body.appendChild(modal);
      
      // Add animation
      requestAnimationFrame(() => {
        modalContent.style.opacity = '1';
        modalContent.style.transform = 'translateY(0)';
      });
    }

    // Load saved theme preference
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = '🌙';
        document.getElementById('theme-text').textContent = 'Dark Mode';
      }
      
      // Initialize components after verification
    });

    // Theme Switcher functionality with persistence
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('theme-icon');
      const themeText = document.getElementById('theme-text');
      
      if (html.getAttribute('data-theme') === 'dark') {
        html.removeAttribute('data-theme');
        themeIcon.textContent = '☀️';
        themeText.textContent = 'Light Mode';
        localStorage.setItem('theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        themeIcon.textContent = '🌙';
        themeText.textContent = 'Dark Mode';
        localStorage.setItem('theme', 'dark');
      }
    }

    // Add toggle function for recipe expansion
    function toggleRecipe(button) {
      const ingredients = button.previousElementSibling;
      const isCollapsed = ingredients.classList.contains('collapsed');
      
      if (isCollapsed) {
        ingredients.classList.remove('collapsed');
        button.innerHTML = 'Show Less <span class="icon">▼</span>';
        button.classList.add('expanded');
      } else {
        ingredients.classList.add('collapsed');
        button.innerHTML = 'Show More <span class="icon">▼</span>';
        button.classList.remove('expanded');
      }
    }

    // Add notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      // Add notification styles if they don't exist
      if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
          }
          
          @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
          }
          
          .notification.success {
            background-color: var(--accent);
          }
          
          .notification.error {
            background-color: #ff3333;
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s ease-out';
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }

    // Add reset function for the Reset Selections button
    function resetSelections() {
      selectedFoods = [];
      selectedDietaryPreference = "none";
      shownMealIds.clear();
      
      // Reset food selections
      const foodItems = document.querySelectorAll('.food-item');
      foodItems.forEach(item => item.classList.remove('selected'));
      
      // Reset dietary preference
      const noPreference = document.getElementById('no-preference');
      if (noPreference) {
        noPreference.checked = true;
        document.querySelectorAll('input[name="diet-preference"]').forEach(opt => 
          opt.closest('.preference-option').classList.remove('selected')
        );
        noPreference.closest('.preference-option').classList.add('selected');
      }

      // Reset meal type (commented out since meal type section was removed)
      /*
      const anyMeal = document.getElementById('any-meal');
      if (anyMeal) {
        anyMeal.checked = true;
        document.querySelectorAll('input[name="meal-type"]').forEach(opt => 
          opt.closest('.preference-option').classList.remove('selected')
        );
        anyMeal.closest('.preference-option').classList.add('selected');
      }
      */
      
      // Clear displays
      document.getElementById('replacementDisplay').innerHTML = '';
      document.getElementById('replacementMeal').innerHTML = '';
      
      // Reset right panel tools
      // Clear ingredient checker
      const ingredientInput = document.getElementById('ingredientInput');
      const ingredientResults = document.getElementById('ingredientResults');
      if (ingredientInput) {
        ingredientInput.value = '';
      }
      if (ingredientResults) {
        ingredientResults.innerHTML = '';
      }
      
      // Update hidden trigger detector
      if (typeof updateHiddenTriggers === 'function') {
        updateHiddenTriggers();
      }
    }

    // Add event listener for reset button
    document.getElementById('resetBtn').addEventListener('click', resetSelections);

    // Function to save a meal to My Saved Meals
    function saveMeal(recipe) {
      const savedMealsContainer = document.getElementById('savedMeals');
      
      // Check if meal is already saved
      const existingSavedMeals = savedMealsContainer.querySelectorAll('.saved-meal');
      for (const savedMeal of existingSavedMeals) {
        if (savedMeal.dataset.recipeId === recipe.id) {
          showNotification('This meal is already saved!', 'error');
          return;
        }
      }
      
      const savedMealCard = document.createElement('div');
      savedMealCard.className = 'saved-meal';
      savedMealCard.dataset.recipeId = recipe.id;
      // Store the full recipe data as a data attribute
      savedMealCard.dataset.recipe = JSON.stringify(recipe);
      
      savedMealCard.innerHTML = `
        <button class="remove-meal-btn" onclick="event.stopPropagation(); removeSavedMeal(this.parentElement)">×</button>
        <h3>${recipe.name}</h3>
        <div class="saved-meal-details">
          ${recipe.isVegetarian ? '<span class="dietary-tag vegetarian">Vegetarian</span>' : ''}
          ${recipe.isVegan ? '<span class="dietary-tag vegan">Vegan</span>' : ''}
        </div>
        <div class="saved-meal-preview">Click to view full details</div>
      `;
      
      // Add click handler to show modal
      savedMealCard.addEventListener('click', function() {
        const savedRecipe = JSON.parse(this.dataset.recipe);
        showSavedMealDetails(savedRecipe);
      });
      
      // Add with animation
      savedMealCard.style.opacity = '0';
      savedMealCard.style.transform = 'translateY(20px)';
      savedMealsContainer.appendChild(savedMealCard);
      
      // Trigger animation
      requestAnimationFrame(() => {
        savedMealCard.style.opacity = '1';
        savedMealCard.style.transform = 'translateY(0)';
      });
      
      showNotification('Meal saved successfully!', 'success');
    }
    
    // Function to remove a saved meal
    function removeSavedMeal(mealElement) {
      // First fade out
      mealElement.style.opacity = '0';
      mealElement.style.transform = 'translateY(20px)';
      
      // Then remove after animation completes
      setTimeout(() => {
        mealElement.remove();
        showNotification('Meal removed', 'success');
      }, 300);
    }

    // Function to show saved meal details in a modal
    function showSavedMealDetails(recipe) {
      const modal = document.createElement('div');
      modal.className = 'recipe-modal saved-meal-modal';
      
      const macros = recipe.macros || {};
      const safeRecipeName = getRecipeImagePath(recipe.name);
      
      // Create image element with proper fallback chain
      const imgElement = document.createElement('img');
      imgElement.className = 'recipe-modal-image';
      imgElement.alt = recipe.name;
      imgElement.src = `./recipe images/${safeRecipeName}.jpg`;
      imgElement.onerror = function() {
        this.onerror = null;
        if(this.src.endsWith('.jpg')) {
          this.src = `./recipe images/${safeRecipeName}.jpeg`;
        } else if(this.src.endsWith('.jpeg')) {
          this.src = `./recipe images/${safeRecipeName}.png`;
        } else {
          this.src = './recipe images/placeholder-meal.jpg';
        }
      };
      
      // Get the current selected trigger foods
      const currentTriggerFoods = Array.from(document.querySelectorAll('.food-item.selected'))
        .map(el => el.querySelector('.food-toggle-btn').textContent.trim());
      
      const modalContent = document.createElement('div');
      modalContent.className = 'recipe-modal-content';
      modalContent.innerHTML = `
        <h2>${recipe.name}</h2>
        <div class="recipe-modal-body">
          <div class="recipe-info">
            <p><strong>Calories:</strong> ${recipe.calories}</p>
            <div class="macro-info">
              ${macros.protein ? `<p><strong>Protein:</strong> ${macros.protein}g</p>` : ''}
              ${macros.carbs ? `<p><strong>Carbs:</strong> ${macros.carbs}g</p>` : ''}
              ${macros.fat ? `<p><strong>Fat:</strong> ${macros.fat}g</p>` : ''}
            </div>
          </div>
          <div class="dietary-tags">
            ${recipe.isVegetarian ? '<span class="dietary-tag vegetarian">Vegetarian</span>' : ''}
            ${recipe.isVegan ? '<span class="dietary-tag vegan">Vegan</span>' : ''}
          </div>
          <div class="ingredients-section">
            <h3>Ingredients:</h3>
            <ul>
              ${displayRecipeIngredients(recipe.ingredients, currentTriggerFoods)}
            </ul>
          </div>
          ${recipe.instructions ? `
            <div class="instructions-section">
              <h3>Instructions:</h3>
              <div class="instructions">
                <ol>
                  ${cleanInstructionsForHTML(extractCooksNotes(recipe.instructions).cleanInstructions)
                    .map(step => `<li>${step}</li>`)
                    .join('')}
                </ol>
              </div>
            </div>
            ${extractCooksNotes(recipe.instructions).cooksNotes.length > 0 ? `
              <div class="cooks-notes-section">
                <h3>Cook's Note${extractCooksNotes(recipe.instructions).cooksNotes.length > 1 ? 's' : ''}:</h3>
                <ul>
                  ${extractCooksNotes(recipe.instructions).cooksNotes.map(note => `<li>${note}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          ` : ''}
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="close-modal-btn">Close</button>
      `;
      
      // Insert the image after the title
      modalContent.insertBefore(imgElement, modalContent.querySelector('.recipe-modal-body'));
      modal.appendChild(modalContent);
      // Add click event listener to modal background
      modal.addEventListener('click', handleModalBackgroundClick);
      document.body.appendChild(modal);
      
      // Add animation
      requestAnimationFrame(() => {
        modalContent.style.opacity = '1';
        modalContent.style.transform = 'translateY(0)';
      });
    }

    // Test function to verify ingredient warning relationships
    function testIngredientWarnings() {
      // Test cases for ingredients and trigger foods
      const testCases = [
        {
          ingredient: "1/4 cup red wine vinegar",
          selectedTriggers: ["Yeast", "Mayonnaise", "Mustard", "Ketchup"],
          expectedWarnings: ["May contain Yeast - check label"]
        },
        {
          ingredient: "2 tablespoons sugar",
          selectedTriggers: ["Ketchup", "Mayonnaise", "Mustard"],
          expectedWarnings: ["Used in Ketchup, Mayonnaise, Mustard"]
        },
        {
          ingredient: "2 tablespoons brown sugar",
          selectedTriggers: ["Ketchup", "Mayonnaise"],
          expectedWarnings: ["Used in Ketchup, Mayonnaise"]
        },
        {
          ingredient: "1/4 cup white vinegar",
          selectedTriggers: ["Yeast", "Mayonnaise", "Ketchup"],
          expectedWarnings: ["May contain Yeast - check label"]
        },
        {
          ingredient: "2 tablespoons honey mustard",
          selectedTriggers: ["Honey", "Sugar"],
          expectedWarnings: ["May contain Honey", "May contain Sugar"]
        },
        {
          ingredient: "1 tablespoon Dijon mustard",
          selectedTriggers: ["Honey", "Sugar"],
          expectedWarnings: ["May contain Honey", "May contain Sugar"]
        },
        {
          ingredient: "1/4 cup mayonnaise",
          selectedTriggers: ["Egg", "Sugar"],
          expectedWarnings: ["Contains Egg", "May contain Sugar"]
        },
        {
          ingredient: "2 tablespoons ketchup",
          selectedTriggers: ["Sugar", "Corn"],
          expectedWarnings: ["Contains Sugar", "May contain High fructose corn syrup"]
        }
      ];

      console.log("Starting ingredient warning relationship tests...");
      
      testCases.forEach((testCase, index) => {
        const warnings = checkIngredientWarnings(testCase.ingredient, testCase.selectedTriggers);
        const warningMessages = warnings.map(w => w.message);
        
        console.log(`\nTest Case ${index + 1}:`);
        console.log(`Ingredient: ${testCase.ingredient}`);
        console.log(`Selected Triggers: ${testCase.selectedTriggers.join(", ")}`);
        console.log(`Expected Warnings: ${testCase.expectedWarnings.join(", ")}`);
        console.log(`Actual Warnings: ${warningMessages.join(", ")}`);
        
        const passed = JSON.stringify(warningMessages.sort()) === JSON.stringify(testCase.expectedWarnings.sort());
        console.log(`Test ${passed ? "PASSED" : "FAILED"}`);
      });
    }

    // Run tests when in development mode
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      document.addEventListener('DOMContentLoaded', testIngredientWarnings);
    }

    // Add function to handle modal background clicks
    function handleModalBackgroundClick(event) {
      if (event.target.classList.contains('recipe-modal') || 
          event.target.classList.contains('replacement-modal')) {
        event.target.remove();
      }
    }

    function filterRecipes() {
      const dietaryPreference = document.getElementById('dietaryPreference').value;
      const mealType = document.getElementById('mealType').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      recipes.forEach(recipe => {
        const recipeElement = document.getElementById(recipe.id);
        if (!recipeElement) return;

        const matchesDiet = dietaryPreference === 'Any' || recipe.dietary.includes(dietaryPreference);
        const matchesMealType = mealType === 'Any' || recipe.mealType === mealType;
        const matchesSearch = recipe.name.toLowerCase().includes(searchTerm);

        recipeElement.style.display = 
          matchesDiet && matchesMealType && matchesSearch ? 'block' : 'none';
      });
    }

    // Function to check if an ingredient contains trigger foods
    function checkIngredientForTriggers(ingredient, triggerFoods) {
      const ingredientLower = ingredient.toLowerCase();
      const triggers = triggerFoods.map(food => food.toLowerCase());
      
      // Helper function to check for exact word matches (not just substring matches)
      const containsExactWord = (text, word) => {
        const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
        return regex.test(text);
      };
      
      // Direct matches (Contains)
      const contains = triggers.filter(trigger => {
        // Check for direct matches and common variations
        const directMatch = ingredientLower.includes(trigger);
        const commonVariations = {
          'egg': [
            'eggs', 'egg yolk', 'egg white', 'egg powder', 'dried egg', 'egg replacer',
            'egg substitute', 'egg protein', 'egg albumin', 'egg globulin'
          ],
          'milk': [
            'dairy', 'cream', 'butter', 'cheese', 'yogurt', 'milk powder', 'dried milk',
            'whey', 'casein', 'lactose', 'lactate', 'lactic acid', 'milk protein',
            'milk solids', 'milk fat', 'milk sugar', 'milk derivative'
          ],
          'wheat': [
            'flour', 'bread', 'pasta', 'cereal', 'wheat flour', 'whole wheat',
            'wheat germ', 'wheat bran', 'wheat starch', 'wheat protein', 'wheat gluten',
            'wheat dextrin', 'wheat malt', 'wheat syrup', 'wheat dextrose',
            'wheat glucose', 'wheat fructose', 'wheat maltodextrin', 'wheat fiber',
            'wheat grass', 'wheat berries', 'wheat groats', 'wheat flakes',
            'wheat meal', 'wheat semolina', 'wheat couscous', 'wheat bulgur'
          ],
          'sugar': [
            'sucrose', 'fructose', 'glucose', 'syrup', 'sugar syrup', 'corn syrup',
            'high fructose corn syrup', 'maple syrup', 'honey syrup', 'agave syrup',
            'brown sugar', 'raw sugar', 'cane sugar', 'beet sugar', 'powdered sugar',
            'confectioners sugar', 'granulated sugar', 'demerara sugar', 'turbinado sugar',
            'maltose', 'dextrose', 'maltodextrin', 'sugar alcohol', 'sugar substitute',
            'artificial sweetener', 'sugar derivative'
          ],
          'soybean': [
            'soy', 'tofu', 'edamame', 'soy protein', 'soy flour', 'soy milk',
            'soy sauce', 'soy oil', 'soy lecithin', 'soy fiber', 'soy isolate',
            'soy concentrate', 'soy powder', 'soy nuts', 'soy yogurt', 'soy cheese',
            'soy meat', 'soy burger', 'soy hot dog', 'soy sausage', 'soy tempeh',
            'soy miso', 'soy natto', 'soy derivative'
          ],
          'oat': [
            'oats', 'oatmeal', 'oat flour', 'oat bran', 'oat fiber', 'oat protein',
            'oat milk', 'oat cream', 'oat yogurt', 'oat bread', 'oat cookie',
            'oat cake', 'oat muffin', 'oat cereal', 'oat granola', 'oat bar',
            'oat groats', 'oat flakes', 'oat meal', 'oat derivative'
          ],
          'rye': [
            'rye flour', 'rye bread', 'rye meal', 'rye flakes', 'rye groats',
            'rye berries', 'rye malt', 'rye syrup', 'rye whiskey', 'rye vodka',
            'rye derivative'
          ],
          'yeast': [
            'baker\'s yeast', 'brewer\'s yeast', 'nutritional yeast', 'yeast extract',
            'yeast protein', 'yeast powder', 'dried yeast', 'active yeast',
            'inactive yeast', 'yeast derivative'
          ],
          'cocoa': [
            'chocolate', 'cacao', 'cocoa powder', 'cocoa butter', 'cocoa mass',
            'cocoa liquor', 'cocoa solids', 'cocoa nibs', 'cocoa extract',
            'cocoa derivative', 'chocolate liquor', 'chocolate powder',
            'chocolate syrup', 'chocolate chips', 'chocolate coating'
          ],
          'lemon': [
            'lemon juice', 'lemon zest', 'lemon oil', 'lemon extract',
            'lemon powder', 'lemon peel', 'lemon pulp', 'lemon concentrate',
            'lemon derivative', 'lemon wedges', 'juice of lemon'
          ],
          'orange': [
            'orange juice', 'orange zest', 'orange oil', 'orange extract',
            'orange powder', 'orange peel', 'orange pulp', 'orange concentrate',
            'orange derivative'
          ],
          'pineapple': [
            'pineapple juice', 'pineapple chunks', 'pineapple rings',
            'pineapple extract', 'pineapple concentrate', 'pineapple powder',
            'pineapple derivative'
          ],
          'honey': [
            'honeycomb', 'honey syrup', 'honey powder', 'honey extract',
            'honey flavor', 'honey derivative', 'honey crystals',
            'honey granules', 'honey paste'
          ],
          'walnut': [
            'walnuts', 'walnut oil', 'walnut flour', 'walnut meal',
            'walnut pieces', 'walnut chunks', 'walnut halves',
            'walnut derivative'
          ],
          'corn': [
            'cornstarch', 'cornmeal', 'corn syrup', 'maize', 'corn flour',
            'corn oil', 'corn protein', 'corn fiber', 'corn gluten',
            'corn dextrin', 'corn maltodextrin', 'corn sugar',
            'corn sweetener', 'corn derivative', 'corn chips',
            'corn tortilla', 'corn bread', 'corn muffin', 'corn cereal',
            'corn grits', 'corn masa', 'corn masa harina'
          ],
          'cabbage': [
            'red cabbage', 'green cabbage', 'savoy cabbage', 'napa cabbage',
            'bok choy', 'chinese cabbage', 'cabbage leaves', 'cabbage juice',
            'cabbage powder', 'cabbage extract', 'cabbage derivative'
          ],
          'grapefruit': [
            'grapefruit juice', 'grapefruit segments', 'grapefruit extract',
            'grapefruit concentrate', 'grapefruit powder', 'grapefruit oil',
            'grapefruit derivative'
          ],
          'black tea': [
            'black tea leaves', 'black tea bags', 'earl grey', 'english breakfast tea',
            'assam tea', 'ceylon tea', 'darjeeling tea'
          ]
        };

        // Check for variations
        const hasVariation = commonVariations[trigger]?.some(variation => 
          ingredientLower.includes(variation)
        );

        return directMatch || hasVariation;
      });

      // If any direct matches are found, don't check for "may contain"
      if (contains.length > 0) {
        return {
          contains,
          mayContain: []
        };
      }

      // Only check for potential matches if no direct matches were found
      const mayContain = triggers.filter(trigger => {
        // Check for ingredients that might contain the trigger
        const potentialMatches = {
          'egg': [
            'mayonnaise', 'dressing', 'sauce', 'batter', 'coating',
            'binder', 'emulsifier', 'thickener', 'baked goods',
            'pastry', 'cake', 'cookie', 'bread', 'pasta'
          ],
          'milk': [
            'sauce', 'dressing', 'batter', 'coating', 'cream sauce',
            'cheese sauce', 'dairy product', 'baked goods',
            'chocolate', 'candy', 'ice cream', 'yogurt',
            'protein powder', 'meal replacement'
          ],
          'wheat': [
            'batter', 'coating', 'thickener', 'baked goods',
            'bread', 'pasta', 'cereal', 'cracker', 'cookie',
            'cake', 'pastry', 'flour', 'starch', 'malt',
            'syrup', 'dextrin', 'maltodextrin'
          ],
          'sugar': [
            'sauce', 'dressing', 'marinade', 'syrup', 'sweetener',
            'baked goods', 'candy', 'chocolate', 'dessert',
            'beverage', 'preservative', 'flavoring', 'ketchup'
          ],
          'soybean': [
            'sauce', 'dressing', 'marinade', 'protein powder',
            'meat substitute', 'vegetarian product', 'vegan product',
            'emulsifier', 'lecithin', 'thickener'
          ],
          'oat': [
            'granola', 'cereal', 'baking', 'bread', 'cookie',
            'muffin', 'bar', 'protein powder', 'meal replacement',
            'thickener', 'binder'
          ],
          'rye': [
            'bread', 'cracker', 'cereal', 'flour', 'baking',
            'whiskey', 'vodka', 'beer'
          ],
          'yeast': [
            'bread', 'dough', 'baking', 'beer', 'wine',
            'fermented food', 'sauce', 'extract'
          ],
          'cocoa': [
            'baking', 'dessert', 'chocolate', 'candy',
            'sauce', 'drink', 'coating', 'filling'
          ],
          'lemon': [
            'sauce', 'dressing', 'marinade', 'beverage',
            'dessert', 'baking', 'cleaning product',
            'flavoring', 'preservative'
          ],
          'orange': [
            'sauce', 'dressing', 'marinade', 'beverage',
            'dessert', 'baking', 'cleaning product',
            'flavoring', 'preservative'
          ],
          'pineapple': [
            'sauce', 'dressing', 'marinade', 'beverage',
            'dessert', 'baking', 'candy', 'preservative'
          ],
          'honey': [
            'sauce', 'dressing', 'marinade', 'beverage',
            'dessert', 'baking', 'candy', 'preservative',
            'natural sweetener'
          ],
          'walnut': [
            'baking', 'dessert', 'salad', 'trail mix',
            'granola', 'cereal', 'snack', 'topping'
          ],
          'corn': [
            'starch', 'thickener', 'baking', 'cereal',
            'snack', 'tortilla', 'chips', 'syrup',
            'sweetener', 'oil', 'protein powder'
          ],
          'cabbage': [
            'salad', 'slaw', 'soup', 'stew', 'fermented food',
            'pickle', 'preserved food', 'vegetable mix'
          ],
          'grapefruit': [
            'sauce', 'dressing', 'marinade', 'beverage',
            'dessert', 'cleaning product', 'flavoring'
          ],
          'black tea': [
            'beverage', 'drink', 'extract', 'flavoring',
            'preservative', 'supplement', 'energy drink'
          ]
        };

        // Check if the ingredient might contain the trigger
        const mightContain = potentialMatches[trigger]?.some(match => 
          containsExactWord(ingredientLower, match)
        );

        return mightContain;
      });

      return {
        contains,
        mayContain
      };
    }

    // Helper function to get recipe image path
    function getRecipeImagePath(recipeName) {
      // Special case mappings for recipes with different image names
      const specialCases = {
        "Chicken Stir Fry": "Chicken Stir-Fry",
        "Mixed Berries and Banana Smoothie": "Mixed Berries and Banana Smoothie (and Smoothie Bowl)",
        "Cookies in a Bowl": "Cookies in a Bowl (with Ice Cream)",
        "Parmesan Chicken Linguini": "Parmesan Chicken Linguini with Sunday Gravy",
        "Chef's Salad": "Chef's Salad with Buttermilk Ranch Dressing",
        "Healthy Tuna Bowl": "Healthy Tuna Grain Bowl with Turmeric Sweet Potatoes and Spicy Yogurt Dressing"
      };

      // Check if this recipe has a special case mapping
      const mappedName = specialCases[recipeName] || recipeName;
      
      // Clean the recipe name to create a valid filename
      // Preserve existing hyphens while handling spaces and special characters
      return mappedName.replace(/[/\\?%*:|"<>]/g, '-');
    }

    // Function to clean text formatting artifacts
    function cleanText(text) {
      if (!text || typeof text !== 'string') return text;
      
      return text
        // Remove leading/trailing whitespace
        .trim()
        // Remove leading hyphens, asterisks, and bullet points
        .replace(/^[-*•·‣⁃]+\s*/, '')
        // Remove leading numbers with dots/parentheses (e.g., "1. ", "1) ")
        .replace(/^\d+[.)]\s*/, '')
        // Remove multiple consecutive spaces
        .replace(/\s+/g, ' ')
        // Remove leading/trailing whitespace again after cleaning
        .trim();
    }

    // Function to clean and format ingredients list
    function cleanIngredientsList(ingredients) {
      if (!ingredients || !Array.isArray(ingredients)) return [];
      
      return ingredients
        .map(ingredient => cleanText(ingredient))
        .filter(ingredient => ingredient && ingredient.length > 0);
    }

    // Function to clean and format instructions
    function cleanInstructions(instructions) {
      if (!instructions || typeof instructions !== 'string') return '';
      
      // Split by newlines and clean each line
      const steps = instructions
        .split('\n')
        .map(line => cleanText(line))
        .filter(line => line && line.length > 0);
      
      // Return numbered steps for plain text display (like PDFs)
      return steps
        .map((step, index) => `${index + 1}. ${step}`)
        .join('\n');
    }

    // Function to clean and format instructions for HTML display (returns array of cleaned steps)
    function cleanInstructionsForHTML(instructions) {
      if (!instructions || typeof instructions !== 'string') return [];
      
      // Split by newlines and clean each line
      return instructions
        .split('\n')
        .map(line => cleanText(line))
        .filter(line => line && line.length > 0);
    }

    // Function to handle image load errors
    function handleImageError(img) {
      const extensions = ['.jpg', '.jpeg', '.webp', '.png'];
      const currentSrc = img.src;
      const baseUrl = 'recipe images/';
      const recipeName = img.dataset.recipeName;
      
      // Get the current extension
      const currentExt = currentSrc.substring(currentSrc.lastIndexOf('.'));
      const currentIndex = extensions.indexOf(currentExt);
      
      // Try next extension if available
      if (currentIndex < extensions.length - 1) {
        const nextExt = extensions[currentIndex + 1];
        img.src = `${baseUrl}${getRecipeImagePath(recipeName)}${nextExt}`;
      } else {
        // If all extensions failed, use placeholder
        img.src = `${baseUrl}placeholder-meal.jpg`;
        img.onerror = null; // Remove error handler to prevent infinite loop
      }
    }

    // Function to extract Cook's Notes from instructions
    function extractCooksNotes(instructions) {
      if (!instructions || typeof instructions !== 'string') return { cleanInstructions: '', cooksNotes: [] };
      
      // Split instructions into lines
      const lines = instructions.split('\n');
      const cooksNotes = [];
      const cleanInstructionLines = [];
      
      for (let line of lines) {
        const trimmedLine = line.trim();
        
        // Check for Cook's Note patterns
        if (trimmedLine.match(/^Cook's Notes?:/i)) {
          // Extract the note after the colon
          const noteText = trimmedLine.replace(/^Cook's Notes?:\s*/i, '').trim();
          if (noteText) {
            cooksNotes.push(noteText);
          }
        } else if (trimmedLine.match(/Cook's Notes?:\s*(.+)/i)) {
          // Extract inline Cook's Note
          const match = trimmedLine.match(/Cook's Notes?:\s*(.+)/i);
          if (match && match[1]) {
            cooksNotes.push(match[1].trim());
          }
          // Remove the Cook's Note from the instruction line
          const cleanLine = trimmedLine.replace(/Cook's Notes?:\s*.+/i, '').trim();
          if (cleanLine) {
            cleanInstructionLines.push(cleanLine);
          }
        } else if (trimmedLine.match(/Cook's Notes?$/i)) {
          // Cook's Note header on its own line - skip it, next lines might contain the notes
          continue;
        } else if (cooksNotes.length > 0 && trimmedLine.startsWith('-') && !trimmedLine.match(/^\d+\./)) {
          // If we've found Cook's Notes and this line starts with -, it's likely a note bullet point
          cooksNotes.push(trimmedLine.replace(/^-\s*/, '').trim());
        } else {
          // Regular instruction line
          if (trimmedLine) {
            cleanInstructionLines.push(trimmedLine);
          }
        }
      }
      
      return {
        cleanInstructions: cleanInstructionLines.join('\n'),
        cooksNotes: cooksNotes
      };
    }

    // Function to create recipe cards
    function createRecipeCard(recipe) {
      const card = document.createElement('div');
      card.className = 'meal-card';
      
      // Format macros for display
      const macros = {
        calories: recipe.calories,
        ...recipe.macros
      };
      
      const macroItems = Object.entries(macros)
        .map(([key, value]) => `
          <div class="macro-item">
            <div class="macro-value">${key === 'calories' ? value : `${value}g`}</div>
            <div class="macro-label">${key}</div>
          </div>
        `)
        .join('');

      // Get selected trigger foods
      const selectedFoods = Array.from(document.querySelectorAll('.food-item.selected'))
        .map(el => el.querySelector('.food-toggle-btn').textContent.trim());

      // Clean and format ingredients with trigger labels
      const cleanedIngredients = cleanIngredientsList(recipe.ingredients);
      const ingredientsList = cleanedIngredients.map(ingredient => {
        const triggers = checkIngredientForTriggers(ingredient, selectedFoods);
        let labels = '';

        if (triggers.contains.length > 0) {
          labels += triggers.contains.map(trigger => 
            `<span class="trigger-label contains">Contains ${trigger}</span>`
          ).join(' ');
        } else if (triggers.mayContain.length > 0) {
          labels += triggers.mayContain.map(trigger => 
            `<span class="trigger-label may-contain">May contain ${trigger}</span>`
          ).join(' ');
        }

        return `<li>${ingredient}${labels}</li>`;
      }).join('');

      // Extract Cook's Notes and clean instructions
      const { cleanInstructions, cooksNotes } = extractCooksNotes(recipe.instructions);
      
      // Clean and format instructions
      const cleanedInstructionSteps = cleanInstructionsForHTML(cleanInstructions);
      const instructionsList = cleanedInstructionSteps
        .map((step, index) => `<li>${step}</li>`)
        .join('');

      // Format Cook's Notes section
      let cooksNotesHtml = '';
      if (cooksNotes.length > 0) {
        const notesContent = cooksNotes.map(note => `<li>${note}</li>`).join('');
        cooksNotesHtml = `
          <div class="cooks-notes">
            <h4>Cook's Note${cooksNotes.length > 1 ? 's' : ''}:</h4>
            <ul>
              ${notesContent}
            </ul>
          </div>
        `;
      }

      // Create the card content
      card.innerHTML = `
        <button class="save-meal-btn" onclick="saveMeal(${JSON.stringify(recipe).replace(/"/g, '&quot;')})">+</button>
        <img class="meal-image" 
             src="recipe images/${getRecipeImagePath(recipe.name)}.jpg" 
             alt="${recipe.name}"
             data-recipe-name="${recipe.name}"
             onerror="handleImageError(this)">
        <h3>${recipe.name}</h3>
        <div class="calories-macros">
          <div class="macros">
            ${macroItems}
          </div>
        </div>
        <div class="ingredients">
          <h4>Ingredients:</h4>
          <ul>
            ${ingredientsList}
          </ul>
        </div>
        <div class="recipe">
          <h4>Instructions:</h4>
          <ol>
            ${instructionsList}
          </ol>
        </div>
        ${cooksNotesHtml}
        <div class="read-more" onclick="toggleCardExpansion(this.parentElement)">
          Read More
        </div>
      `;

      return card;
    }

    // Function to toggle card expansion
    function toggleCardExpansion(card) {
      card.classList.toggle('expanded');
    }

    // Function to add recipe to saved meals
    function addToSavedMeals(recipeId) {
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) return;

      // Get existing saved meals or initialize empty array
      let savedMeals = JSON.parse(localStorage.getItem('savedMeals') || '[]');
      
      // Check if recipe is already saved
      if (!savedMeals.some(m => m.id === recipeId)) {
        savedMeals.push(recipe);
        localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
        
        // Show success message
        const notification = document.createElement('div');
        notification.className = 'notification success';
        notification.textContent = 'Recipe added to saved meals!';
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    }

    // Export Saved Meals as PDF
    document.getElementById('exportMealsPDFBtn').addEventListener('click', showExportOptions);

    // Function to show export options modal
    function showExportOptions() {
      const savedMealsContainer = document.getElementById('savedMeals');
      const mealCards = savedMealsContainer.querySelectorAll('.saved-meal');
      
      if (!savedMealsContainer || mealCards.length === 0) {
        showNotification('No saved meals to export.', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'recipe-modal export-options-modal';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'recipe-modal-content';
      modalContent.style.maxWidth = '500px';
      
      modalContent.innerHTML = `
        <h2>Export Saved Meals</h2>
        <div class="export-options">
          <p>You have ${mealCards.length} saved meal${mealCards.length > 1 ? 's' : ''} to export.</p>
          
          <div class="export-option" style="margin: 20px 0;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="export-type" value="individual" checked style="margin-right: 10px;">
              <div>
                <strong>Individual PDFs</strong>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                  Create separate PDF files for each saved meal (${mealCards.length} file${mealCards.length > 1 ? 's' : ''})
                </div>
              </div>
            </label>
          </div>
          
          <div class="export-option" style="margin: 20px 0;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="export-type" value="combined" style="margin-right: 10px;">
              <div>
                <strong>Combined PDF</strong>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                  Create one PDF with all saved meals (1 file with ${mealCards.length} meal${mealCards.length > 1 ? 's' : ''})
                </div>
              </div>
            </label>
          </div>
          
          <div style="margin: 30px 0 20px 0; padding-top: 20px; border-top: 1px solid #ddd;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="include-images" checked style="margin-right: 10px;">
              <span>Include meal images (recommended for complete meal cards)</span>
            </label>
          </div>
          
          <div style="font-size: 0.9em; color: #666; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
            <strong>What's included:</strong> Recipe name, nutritional information, full ingredients list, 
            step-by-step cooking instructions, and dietary tags (vegetarian/vegan).
          </div>
        </div>
        
        <div class="modal-buttons" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button onclick="this.closest('.recipe-modal').remove()" 
                  style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">
            Cancel
          </button>
          <button onclick="startExport()" 
                  style="padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">
            Export PDFs
          </button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      modal.addEventListener('click', handleModalBackgroundClick);
      document.body.appendChild(modal);
    }

    // Function to start the export process
    async function startExport() {
      const modal = document.querySelector('.export-options-modal');
      const exportType = modal.querySelector('input[name="export-type"]:checked').value;
      const includeImages = modal.querySelector('#include-images').checked;
      
      modal.remove();
      
      // Show loading notification
      const loadingNotification = document.createElement('div');
      loadingNotification.className = 'notification loading';
      loadingNotification.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
          Generating PDF${exportType === 'individual' ? 's' : ''}...
        </div>
      `;
      document.body.appendChild(loadingNotification);
      
      try {
        if (exportType === 'individual') {
          await exportIndividualMealPDFs(includeImages);
        } else {
          await exportCombinedMealPDF(includeImages);
        }
        
        loadingNotification.remove();
        showNotification(`PDF${exportType === 'individual' ? 's' : ''} exported successfully!`, 'success');
      } catch (error) {
        console.error('Export error:', error);
        loadingNotification.remove();
        showNotification('Failed to export PDFs. Please try again.', 'error');
      }
    }

    // Function to export individual PDFs for each saved meal
    async function exportIndividualMealPDFs(includeImages = true) {
      const savedMealsContainer = document.getElementById('savedMeals');
      const mealCards = savedMealsContainer.querySelectorAll('.saved-meal');
      
      for (let i = 0; i < mealCards.length; i++) {
        const card = mealCards[i];
        const recipe = JSON.parse(card.dataset.recipe);
        
        await createMealPDF(recipe, includeImages, true);
        
        // Small delay to prevent browser overload
        if (i < mealCards.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
    }

    // Function to export combined PDF with all saved meals
    async function exportCombinedMealPDF(includeImages = true) {
      const savedMealsContainer = document.getElementById('savedMeals');
      const mealCards = savedMealsContainer.querySelectorAll('.saved-meal');
      
      const pdf = new window.jspdf.jsPDF({ 
        orientation: 'portrait', 
        unit: 'pt', 
        format: 'a4' 
      });
      
      let isFirstPage = true;
      
      for (let i = 0; i < mealCards.length; i++) {
        const card = mealCards[i];
        const recipe = JSON.parse(card.dataset.recipe);
        
        if (!isFirstPage) {
          pdf.addPage();
        }
        
        await addMealToPDF(pdf, recipe, includeImages);
        isFirstPage = false;
      }
      
      pdf.save('My_Saved_Meals_Complete.pdf');
    }

    // Function to create a complete PDF for a single meal
    async function createMealPDF(recipe, includeImages = true, saveIndividually = false) {
      const pdf = new window.jspdf.jsPDF({ 
        orientation: 'portrait', 
        unit: 'pt', 
        format: 'a4' 
      });
      
      await addMealToPDF(pdf, recipe, includeImages);
      
      if (saveIndividually) {
        const filename = `${recipe.name.replace(/[/\\?%*:|"<>]/g, '-')}_Meal_Card.pdf`;
        pdf.save(filename);
      }
      
      return pdf;
    }

    // Function to add meal content to PDF
    async function addMealToPDF(pdf, recipe, includeImages = true) {
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 40;
      const contentWidth = pageWidth - (2 * margin);
      let yPosition = margin;
      
      // Brand colors - using your specific brand palette
      const brandColors = {
        primary: [81, 186, 173],     // #51baad - Primary teal
        secondary: [6, 42, 57],      // #062a39 - Dark navy
        accent: [68, 137, 201],      // #4489c9 - Blue
        highlight: [163, 201, 98],   // #a3c962 - Green
        danger: [206, 15, 74],       // #ce0f4a - Red
        white: [255, 255, 255],      // #ffffff - White
        lightGray: [245, 245, 245],  // Light gray for backgrounds
        textGray: [102, 102, 102]    // Text gray
      };
      
      // Brand header with logo area
      pdf.setFillColor(...brandColors.primary);
      pdf.rect(0, 0, pageWidth, 70, 'F');
      
      // Logo placeholder area
      pdf.setFillColor(...brandColors.white);
      pdf.rect(margin, 15, 40, 40, 'F');
      pdf.setDrawColor(...brandColors.secondary);
      pdf.setLineWidth(2);
      pdf.rect(margin, 15, 40, 40, 'S');
      
      // Brand text in logo area
      pdf.setTextColor(...brandColors.primary);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'bold');
      pdf.text('inFoods', margin + 20, 38, { align: 'center' });
      
      // Header title
      pdf.setTextColor(...brandColors.white);
      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Trigger Food Navigator', margin + 55, 30);
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'normal');
      pdf.text('Personalized IBS Meal Planning', margin + 55, 45);
      
      yPosition = 90;
      
      // Recipe title with brand accent
      pdf.setFillColor(...brandColors.secondary);
      pdf.rect(margin, yPosition, contentWidth, 45, 'F');
      
      // Accent stripe
      pdf.setFillColor(...brandColors.highlight);
      pdf.rect(margin, yPosition, 8, 45, 'F');
      
      pdf.setTextColor(...brandColors.white);
      pdf.setFontSize(24);
      pdf.setFont('helvetica', 'bold');
      
      const recipeName = recipe.name || 'Untitled Recipe';
      const titleLines = pdf.splitTextToSize(recipeName, contentWidth - 20);
      const titleY = yPosition + 20 + (titleLines.length > 1 ? 5 : 10);
      pdf.text(titleLines, margin + 15, titleY);
      yPosition += 65;
      
      // Add meal image if requested
      if (includeImages) {
        try {
          const imageData = await loadRecipeImage(recipeName);
          if (imageData) {
            // Image with brand-colored border
            const imageWidth = contentWidth;
            const imageHeight = 200;
            
            // Brand-colored border
            pdf.setDrawColor(...brandColors.primary);
            pdf.setLineWidth(3);
            pdf.rect(margin, yPosition, imageWidth, imageHeight, 'S');
            
            // Calculate proper image dimensions to crop from center and fit edge-to-edge
            const img = new Image();
            img.src = imageData;
            
            await new Promise((resolve) => {
              img.onload = resolve;
              img.onerror = resolve;
            });
            
            const imgWidth = img.width || 400;
            const imgHeight = img.height || 300;
            const imgAspectRatio = imgWidth / imgHeight;
            
            // Calculate the container aspect ratio (inside the border)
            const containerWidth = imageWidth - 6; // Account for 3px border on each side
            const containerHeight = imageHeight - 6; // Account for 3px border on each side
            const containerAspectRatio = containerWidth / containerHeight;
            
            let cropWidth, cropHeight, cropX, cropY;
            let displayWidth = containerWidth;
            let displayHeight = containerHeight;
            
            if (imgAspectRatio > containerAspectRatio) {
              // Image is wider than container - crop from sides
              cropHeight = imgHeight;
              cropWidth = imgHeight * containerAspectRatio;
              cropX = (imgWidth - cropWidth) / 2; // Center horizontally
              cropY = 0;
            } else {
              // Image is taller than container - crop from top/bottom
              cropWidth = imgWidth;
              cropHeight = imgWidth / containerAspectRatio;
              cropX = 0;
              cropY = (imgHeight - cropHeight) / 2; // Center vertically
            }
            
            // Position the image to fill the container edge-to-edge (inside border)
            const imageX = margin + 3; // Account for border
            const imageY = yPosition + 3; // Account for border
            
            // Add the cropped image that fills edge-to-edge
            pdf.addImage(
              imageData, 
              'JPEG', 
              imageX, 
              imageY, 
              displayWidth, 
              displayHeight, 
              undefined, 
              'MEDIUM',
              0, // rotation
              cropX, 
              cropY, 
              cropWidth, 
              cropHeight
            );
            
            yPosition += imageHeight + 25;
          }
        } catch (error) {
          console.log('Could not load image for', recipeName);
          yPosition += 20;
        }
      }
      
      // Nutrition information bar with brand styling
      const nutritionHeight = 70;
      
      // Background with gradient effect (using multiple rectangles)
      pdf.setFillColor(250, 250, 250);
      pdf.rect(margin, yPosition, contentWidth, nutritionHeight, 'F');
      
      // Brand accent top border
      pdf.setFillColor(...brandColors.accent);
      pdf.rect(margin, yPosition, contentWidth, 4, 'F');
      
      // Border
      pdf.setDrawColor(...brandColors.primary);
      pdf.setLineWidth(1);
      pdf.rect(margin, yPosition, contentWidth, nutritionHeight, 'S');
      
      // Nutrition values
      const calories = recipe.calories || 'N/A';
      const protein = recipe.macros?.protein || 'N/A';
      const carbs = recipe.macros?.carbs || 'N/A';
      const fat = recipe.macros?.fat || 'N/A';
      
      // Calculate positions for nutrition items
      const nutritionItems = [
        { label: 'Calories', value: calories, unit: '', color: brandColors.danger },
        { label: 'Protein', value: protein, unit: 'g', color: brandColors.primary },
        { label: 'Carbs', value: carbs, unit: 'g', color: brandColors.accent },
        { label: 'Fat', value: fat, unit: 'g', color: brandColors.highlight }
      ];
      
      const itemWidth = contentWidth / nutritionItems.length;
      
      nutritionItems.forEach((item, index) => {
        const itemX = margin + (index * itemWidth) + (itemWidth / 2);
        
        // Colored circle background for values
        pdf.setFillColor(...item.color);
        pdf.circle(itemX, yPosition + 30, 18, 'F');
        
        // Value (large, white text on colored background)
        pdf.setTextColor(...brandColors.white);
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        const valueText = `${item.value}${item.unit}`;
        pdf.text(valueText, itemX, yPosition + 33, { align: 'center' });
        
        // Label (smaller, brand colored)
        pdf.setTextColor(...item.color);
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'bold');
        pdf.text(item.label, itemX, yPosition + 55, { align: 'center' });
      });
      
      yPosition += nutritionHeight + 30;
      
      // Get current selected trigger foods for PDF generation
      const currentTriggerFoods = Array.from(document.querySelectorAll('.food-item.selected'))
        .map(el => el.querySelector('.food-toggle-btn').textContent.trim());
      
      // Check for page break before ingredients
      if (yPosition > pageHeight - 300) {
        pdf.addPage();
        yPosition = margin + 20;
        
        // Add mini brand header on new page
        pdf.setFillColor(...brandColors.primary);
        pdf.rect(0, 0, pageWidth, 25, 'F');
        pdf.setTextColor(...brandColors.white);
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Trigger Food Navigator', margin, 17);
        yPosition = margin + 40;
      }
      
      // Ingredients section with brand styling
      pdf.setFillColor(...brandColors.secondary);
      pdf.rect(margin, yPosition, contentWidth, 35, 'F');
      
      // Accent stripe
      pdf.setFillColor(...brandColors.highlight);
      pdf.rect(margin, yPosition, 6, 35, 'F');
      
      pdf.setTextColor(...brandColors.white);
      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Ingredients', margin + 15, yPosition + 22);
      yPosition += 45;
      
      // Ingredients list with brand accents
      if (recipe.ingredients && recipe.ingredients.length > 0) {
        const cleanedIngredients = cleanIngredientsList(recipe.ingredients);
        
        pdf.setTextColor(...brandColors.secondary);
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        cleanedIngredients.forEach((ingredient) => {
          if (yPosition > pageHeight - 80) {
            pdf.addPage();
            yPosition = margin + 40;
            
            // Add mini brand header on new page
            pdf.setFillColor(...brandColors.primary);
            pdf.rect(0, 0, pageWidth, 25, 'F');
            pdf.setTextColor(...brandColors.white);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Trigger Food Navigator', margin, 17);
            yPosition = margin + 40;
          }
          
          const cleanIngredient = ingredient ? ingredient.trim() : '';
          if (cleanIngredient) {
            const warnings = checkIngredientWarnings(cleanIngredient, currentTriggerFoods);
            
            // Brand-colored bullet point
            pdf.setFillColor(...brandColors.primary);
            pdf.circle(margin + 15, yPosition - 2, 3, 'F');
            
            // Ingredient text
            pdf.setTextColor(...brandColors.secondary);
            let ingredientText = cleanIngredient;
            
            // Add trigger warnings
            warnings.forEach(warning => {
              if (warning.type === 'contains') {
                ingredientText += ` [Contains ${warning.triggerFood}]`;
              } else if (warning.type === 'mayContain') {
                ingredientText += ` [May contain ${warning.triggerFood}]`;
              }
            });
            
            const lines = pdf.splitTextToSize(ingredientText, contentWidth - 50);
            
            lines.forEach((line, lineIndex) => {
              if (line.includes('[Contains') || line.includes('[May contain')) {
                // Handle trigger warning text with brand colors
                const parts = line.split(/(\[Contains [^\]]+\]|\[May contain [^\]]+\])/);
                let currentX = margin + 25;
                
                parts.forEach(part => {
                  if (part.includes('[Contains')) {
                    pdf.setTextColor(...brandColors.danger); // Brand red for contains
                    pdf.setFont('helvetica', 'bold');
                  } else if (part.includes('[May contain')) {
                    pdf.setTextColor(...brandColors.highlight); // Brand green for may contain
                    pdf.setFont('helvetica', 'bold');
                  } else {
                    pdf.setTextColor(...brandColors.secondary);
                    pdf.setFont('helvetica', 'normal');
                  }
                  
                  if (part.trim()) {
                    pdf.text(part, currentX, yPosition);
                    currentX += pdf.getTextWidth(part);
                  }
                });
              } else {
                pdf.setTextColor(...brandColors.secondary);
                pdf.setFont('helvetica', 'normal');
                pdf.text(line, margin + 25, yPosition);
              }
              
              if (lineIndex < lines.length - 1) {
                yPosition += 14;
              }
            });
            
            yPosition += 18;
          }
        });
      } else {
        pdf.setTextColor(...brandColors.textGray);
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'italic');
        pdf.text('No ingredients listed', margin + 25, yPosition);
        yPosition += 25;
      }
      
      yPosition += 25;
      
      // Instructions section with brand styling
      if (recipe.instructions) {
        // Check for page break before instructions
        if (yPosition > pageHeight - 200) {
          pdf.addPage();
          yPosition = margin + 40;
          
          // Add mini brand header on new page
          pdf.setFillColor(...brandColors.primary);
          pdf.rect(0, 0, pageWidth, 25, 'F');
          pdf.setTextColor(...brandColors.white);
          pdf.setFontSize(10);
          pdf.setFont('helvetica', 'bold');
          pdf.text('Trigger Food Navigator', margin, 17);
          yPosition = margin + 40;
        }
        
        // Instructions header with brand styling
        pdf.setFillColor(...brandColors.secondary);
        pdf.rect(margin, yPosition, contentWidth, 35, 'F');
        
        // Accent stripe
        pdf.setFillColor(...brandColors.accent);
        pdf.rect(margin, yPosition, 6, 35, 'F');
        
        pdf.setTextColor(...brandColors.white);
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Instructions', margin + 15, yPosition + 22);
        yPosition += 45;
        
        // Extract and clean instructions
        const { cleanInstructions, cooksNotes } = extractCooksNotes(recipe.instructions);
        const instructionSteps = cleanInstructionsForHTML(cleanInstructions);
        
        pdf.setTextColor(...brandColors.secondary);
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        instructionSteps.forEach((step, index) => {
          if (yPosition > pageHeight - 80) {
            pdf.addPage();
            yPosition = margin + 40;
            
            // Add mini brand header on new page
            pdf.setFillColor(...brandColors.primary);
            pdf.rect(0, 0, pageWidth, 25, 'F');
            pdf.setTextColor(...brandColors.white);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Trigger Food Navigator', margin, 17);
            yPosition = margin + 40;
          }
          
          // Step number with brand styling
          pdf.setFillColor(...brandColors.accent);
          pdf.circle(margin + 15, yPosition - 2, 8, 'F');
          
          pdf.setTextColor(...brandColors.white);
          pdf.setFontSize(10);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`${index + 1}`, margin + 15, yPosition + 2, { align: 'center' });
          
          // Step text
          pdf.setTextColor(...brandColors.secondary);
          pdf.setFontSize(11);
          pdf.setFont('helvetica', 'normal');
          
          const stepLines = pdf.splitTextToSize(step, contentWidth - 50);
          stepLines.forEach((line, lineIndex) => {
            pdf.text(line, margin + 30, yPosition);
            if (lineIndex < stepLines.length - 1) {
              yPosition += 14;
            }
          });
          
          yPosition += 22;
        });
        
        // Cook's Notes section with brand styling
        if (cooksNotes.length > 0) {
          yPosition += 15;
          
          if (yPosition > pageHeight - 120) {
            pdf.addPage();
            yPosition = margin + 40;
            
            // Add mini brand header on new page
            pdf.setFillColor(...brandColors.primary);
            pdf.rect(0, 0, pageWidth, 25, 'F');
            pdf.setTextColor(...brandColors.white);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Trigger Food Navigator', margin, 17);
            yPosition = margin + 40;
          }
          
          // Cook's Notes header with brand accent
          pdf.setFillColor(...brandColors.highlight);
          pdf.rect(margin, yPosition, contentWidth, 25, 'F');
          
          pdf.setTextColor(...brandColors.white);
          pdf.setFontSize(12);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`Cook's Note${cooksNotes.length > 1 ? 's' : ''}`, margin + 10, yPosition + 16);
          yPosition += 35;
          
          pdf.setTextColor(...brandColors.secondary);
          pdf.setFontSize(10);
          pdf.setFont('helvetica', 'normal');
          
          cooksNotes.forEach(note => {
            if (yPosition > pageHeight - 60) {
              pdf.addPage();
              yPosition = margin + 40;
              
              // Add mini brand header on new page
              pdf.setFillColor(...brandColors.primary);
              pdf.rect(0, 0, pageWidth, 25, 'F');
              pdf.setTextColor(...brandColors.white);
              pdf.setFontSize(10);
              pdf.setFont('helvetica', 'bold');
              pdf.text('Trigger Food Navigator', margin, 17);
              yPosition = margin + 40;
            }
            
            // Note icon with brand color
            pdf.setTextColor(...brandColors.highlight);
            pdf.setFontSize(12);
            pdf.text('💡', margin + 10, yPosition);
            
            pdf.setTextColor(...brandColors.secondary);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            const noteLines = pdf.splitTextToSize(note, contentWidth - 40);
            noteLines.forEach((line, lineIndex) => {
              pdf.text(line, margin + 25, yPosition);
              if (lineIndex < noteLines.length - 1) {
                yPosition += 12;
              }
            });
            
            yPosition += 18;
          });
        }
      }
      
      // Brand footer
      const footerY = pageHeight - 50;
      
      // Footer background
      pdf.setFillColor(...brandColors.secondary);
      pdf.rect(0, footerY, pageWidth, 50, 'F');
      
      // Brand accent stripe
      pdf.setFillColor(...brandColors.primary);
      pdf.rect(0, footerY, pageWidth, 4, 'F');
      
      pdf.setTextColor(...brandColors.white);
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Trigger Food Navigator', margin, footerY + 20);
      
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'normal');
      pdf.text('Personalized meal planning for IBS management', margin, footerY + 32);
      
      const dateText = `Generated on ${new Date().toLocaleDateString()}`;
      pdf.text(dateText, pageWidth - margin - pdf.getTextWidth(dateText), footerY + 20);
      
      // Brand website/contact info
      pdf.setTextColor(...brandColors.primary);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'normal');
      pdf.text('www.infoodsibs.com', pageWidth - margin - pdf.getTextWidth('www.infoodsibs.com'), footerY + 32);
    }

    // Function to load recipe image and convert to base64
    async function loadRecipeImage(recipeName) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        const safeRecipeName = getRecipeImagePath(recipeName);
        const extensions = ['.jpg', '.jpeg', '.png', '.webp'];
        let currentIndex = 0;
        
        const tryNextExtension = () => {
          if (currentIndex >= extensions.length) {
            resolve(null);
            return;
          }
          
          img.src = `./recipe images/${safeRecipeName}${extensions[currentIndex]}`;
          currentIndex++;
        };
        
        img.onload = function() {
          try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            
            ctx.drawImage(img, 0, 0);
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            resolve(dataURL);
          } catch (error) {
            console.error('Error converting image to base64:', error);
            resolve(null);
          }
        };
        
        img.onerror = tryNextExtension;
        tryNextExtension();
      });
    }
  </script>
  <!-- Add jsPDF and html2canvas CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Initialize Ingredient Checker and Hidden Trigger Detector -->
  <script>
    // Initialize the right panel tools
    document.addEventListener('DOMContentLoaded', function() {
      initializeIngredientChecker();
      initializeHiddenTriggerDetector();
    });

    // Ingredient Checker functionality
    function initializeIngredientChecker() {
      const ingredientInput = document.getElementById('ingredientInput');
      const ingredientResults = document.getElementById('ingredientResults');
      
      // Real-time analysis as user types
      ingredientInput.addEventListener('input', function() {
        const ingredient = this.value.trim();
        if (ingredient.length > 2) {
          analyzeIngredient(ingredient);
        } else {
          ingredientResults.innerHTML = '';
        }
      });
      
      function analyzeIngredient(ingredient) {
        const selectedTriggerFoods = Array.from(document.querySelectorAll('.food-item.selected'))
          .map(el => el.querySelector('.food-toggle-btn').textContent.trim());
        
        if (selectedTriggerFoods.length === 0) {
          ingredientResults.innerHTML = `
            <div class="ingredient-result warning">
              <h4>⚠️ Select Trigger Foods First</h4>
              <p>Please select your trigger foods from the left panel to analyze ingredients.</p>
            </div>
          `;
          return;
        }
        
        // Use only the checkIngredientWarnings function for comprehensive analysis
        const warnings = checkIngredientWarnings(ingredient, selectedTriggerFoods);
        
        // Separate Contains and May Contain warnings
        const containsWarnings = warnings.filter(w => w.type === 'contains');
        const mayContainWarnings = warnings.filter(w => w.type === 'mayContain');
        
        // Extract unique trigger foods (using Set to avoid duplicates)
        const containsTriggers = [...new Set(containsWarnings.map(w => w.triggerFood))];
        const mayContainTriggers = [...new Set(mayContainWarnings.map(w => w.triggerFood))];
        
        let resultHtml = '';
        
        if (containsTriggers.length > 0) {
          resultHtml = `
            <div class="ingredient-result danger">
              <h4>🚫 Contains Trigger Foods</h4>
              <p><strong>Direct matches:</strong> ${containsTriggers.join(', ')}</p>
              <p><strong>Recommendation:</strong> Avoid this ingredient completely.</p>
            </div>
          `;
        } else if (mayContainTriggers.length > 0) {
          resultHtml = `
            <div class="ingredient-result warning">
              <h4>⚠️ May Contain Trigger Foods</h4>
              <p><strong>Potential triggers:</strong> ${mayContainTriggers.join(', ')}</p>
              <p><strong>Recommendation:</strong> Check product labels carefully or choose alternatives.</p>
            </div>
          `;
        } else {
          resultHtml = `
            <div class="ingredient-result safe">
              <h4>✅ Appears Safe</h4>
              <p>This ingredient doesn't appear to contain your selected trigger foods.</p>
              <p><strong>Note:</strong> Always check product labels for complete ingredient lists.</p>
            </div>
          `;
        }
        
        ingredientResults.innerHTML = resultHtml;
      }
    }

    // Hidden Trigger Detector functionality
    function initializeHiddenTriggerDetector() {
      const hiddenTriggersList = document.getElementById('hiddenTriggersList');
      
      // Update hidden triggers when trigger foods selection changes
      document.addEventListener('click', function(e) {
        if (e.target.closest('.food-item')) {
          setTimeout(updateHiddenTriggers, 100); // Small delay to ensure selection is updated
        }
      });
      
      function updateHiddenTriggers() {
        const selectedTriggerFoods = Array.from(document.querySelectorAll('.food-item.selected'))
          .map(el => el.querySelector('.food-toggle-btn').textContent.trim());
        
        if (selectedTriggerFoods.length === 0) {
          hiddenTriggersList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text); font-style: italic;">
              Select your trigger foods to see hidden sources
            </div>
          `;
          return;
        }
        
        const hiddenSources = getHiddenTriggerSources(selectedTriggerFoods);
        
        let htmlContent = '';
        Object.keys(hiddenSources).forEach(triggerFood => {
          const sources = hiddenSources[triggerFood];
          if (sources.length > 0) {
            htmlContent += `
              <div class="trigger-category">
                <div class="trigger-category-header" onclick="toggleTriggerCategory(this)">
                  <span>${triggerFood} Hidden Sources</span>
                  <span class="expand-icon">▼</span>
                </div>
                <div class="trigger-category-content">
                  ${sources.map(source => `
                    <div class="hidden-food-item">• ${source}</div>
                  `).join('')}
                </div>
              </div>
            `;
          }
        });
        
        hiddenTriggersList.innerHTML = htmlContent;
      }
      
      // Initialize with current selection
      updateHiddenTriggers();
    }

    // Toggle trigger category expansion
    function toggleTriggerCategory(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('.expand-icon');
      
      content.classList.toggle('expanded');
      icon.classList.toggle('rotated');
    }

    // Get hidden trigger sources for selected trigger foods
    function getHiddenTriggerSources(selectedTriggerFoods) {
      const hiddenSources = {};
      
      const unexpectedSources = {
        'Milk': [
          'Lunch meats and hot dogs',
          'Bread and baked goods',
          'Salad dressings',
          'Chocolate and candy',
          'Instant mashed potatoes',
          'Canned tuna fish',
          'Non-dairy creamers',
          'Margarine'
        ],
        'Wheat': [
          'Soy sauce',
          'Imitation crab meat',
          'Soup broths and bouillon',
          'French fries (coated)',
          'Salad dressings',
          'Ice cream cones',
          'Beer and malt beverages',
          'Seasoning mixes',
          'Processed meats'
        ],
        'Egg': [
          'Pasta (even some dry pasta)',
          'Marshmallows',
          'Surimi (imitation crab)',
          'Foam on specialty coffee drinks',
          'Wine (egg whites used in fining)',
          'Pretzels (egg wash)',
          'Meatballs and meatloaf',
          'Caesar salad dressing',
          'Hollandaise sauce'
        ],
        'Soybean': [
          'Chocolate',
          'Baked goods',
          'Canned tuna',
          'Infant formulas',
          'Margarine',
          'Mayonnaise',
          'Protein bars',
          'Asian restaurant foods',
          'Vegetarian meat substitutes'
        ],
        'Sugar': [
          'Dried fruits',
          'Pickles',
          'Salad dressings',
          'Crackers',
          'Bread',
          'Peanut butter',
          'Protein bars',
          'Flavored water',
          'Canned vegetables',
          'Processed meats'
        ],
        'Corn': [
          'Baking powder',
          'Vanilla extract',
          'Powdered sugar',
          'Deli meats',
          'Fish sticks',
          'Canned fruits',
          'Salad dressings',
          'Candy and gum',
          'Frozen foods'
        ],
        'Yeast': [
          'Aged cheeses',
          'Vinegar',
          'Mushrooms',
          'Dried fruits',
          'Pickled foods',
          'Wine and beer',
          'Fermented foods',
          'Soy sauce',
          'Miso soup'
        ],
        'Honey': [
          'Graham crackers',
          'Granola and energy bars',
          'Baked ham',
          'Barbecue sauce',
          'Herbal teas',
          'Cough drops',
          'Breakfast cereals',
          'Glazed meats',
          'Honey mustard'
        ],
        'Walnut': [
          'Pesto sauce',
          'Baklava and Middle Eastern desserts',
          'Waldorf salad',
          'Multigrain breads',
          'Energy bars',
          'Ice cream flavors',
          'Liqueurs',
          'Trail mix',
          'Stuffing mixes'
        ],
        'Cocoa': [
          'Mole sauce',
          'Coffee drinks',
          'Protein powders',
          'Flavored yogurts',
          'Breakfast cereals',
          'Chili seasonings',
          'Some wines',
          'Tiramisu',
          'Hot chocolate mixes'
        ],
        'Lemon': [
          'Flavored waters',
          'Tea blends',
          'Seafood dishes',
          'Salad dressings',
          'Marinades',
          'Desserts and pastries',
          'Cocktails and beverages',
          'Preserved foods',
          'Lemon pepper seasoning'
        ],
        'Orange': [
          'Grand Marnier and liqueurs',
          'Tea blends',
          'Duck à l\'orange',
          'Marmalades and jams',
          'Flavored yogurts',
          'Breakfast cereals',
          'Cocktails and beverages',
          'Desserts and pastries',
          'Orange chicken dishes'
        ],
        'Pineapple': [
          'Pizza toppings',
          'Asian stir-fry dishes',
          'Cocktail mixers',
          'Meat tenderizers',
          'Tropical fruit blends',
          'Ham glazes',
          'Salsa varieties',
          'Sweet and sour sauce',
          'Upside-down cake'
        ],
        'Grapefruit': [
          'Cocktail mixers',
          'Fruit salads',
          'Breakfast cereals',
          'Flavored waters',
          'Salad dressings',
          'Marinades',
          'Desserts',
          'Smoothie mixes',
          'Citrus seasonings'
        ],
        'Oat': [
          'Granola bars',
          'Baby foods',
          'Protein powders',
          'Gluten-free products',
          'Beer (some varieties)',
          'Instant breakfast drinks',
          'Muesli',
          'Energy bars',
          'Breakfast cookies'
        ],
        'Rye': [
          'Rye whiskey',
          'Pumpernickel bread',
          'Crisp breads',
          'Some vodkas',
          'Deli meats (caraway/rye seasoning)',
          'Sourdough starters',
          'Beer varieties',
          'Multigrain products',
          'Traditional European breads'
        ],
        'Cabbage': [
          'Kimchi',
          'Sauerkraut',
          'Coleslaw mixes',
          'Asian fermented foods',
          'Soup mixes',
          'Pickled vegetables',
          'Fermented drinks',
          'Traditional European dishes',
          'Stuffed cabbage rolls'
        ],
        'Black Tea': [
          'Earl Grey and flavored teas',
          'Chai spice blends',
          'Kombucha',
          'Energy drinks',
          'Iced tea mixes',
          'Tea-flavored foods',
          'Bubble tea',
          'Tea-infused desserts',
          'Thai iced tea'
        ]
      };
      
      selectedTriggerFoods.forEach(triggerFood => {
        if (unexpectedSources[triggerFood]) {
          hiddenSources[triggerFood] = unexpectedSources[triggerFood];
        }
      });
      
      return hiddenSources;
    }
  </script>
</body>
</html>
